/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import EventEmitter from"./eventEmitter.js";import{DiagramState,TOOL_MODE_WIRE}from"./diagram.js";import Geometry from"./geometry.js";export class Component extends EventEmitter{constructor(t){super(),this._state=t,t.id||(t.id=DiagramState.instance.getNewIdentity(),t.className=this.constructor.name,DiagramState.instance.registerComponent(this),t.nodeAttrs=t.nodeAttrs||{},t.pinIds=t.pinIds||[],this._createChildComponents())}get fullName(){return this.state.label?`${this.state.label} ${this.constructor.name} (${this.id})`:`${this.constructor.name} (${this.id})`}get id(){return this._state.id}get state(){return this._state}get pinIds(){return this._state.pinIds}get nodeAttrs(){return this._state.nodeAttrs}set nodeAttrs(t){this._state.nodeAttrs=t}static get ImageURL(){throw new Error("abstract method call")}static get IsDraggable(){return!0}static get labelNodeName(){return"component-label"}get label(){return this.state.label??""}updateLabel(t,e){const n=t||"";if(n!==this.state.label){this.state.label=n;const t=this.findNode(e);this._drawLabel(t)}}can(t){return"function"==typeof this[t]}moveTo(t){this.nodeAttrs.x=t.x,this.nodeAttrs.y=t.y}async draw(t){const e=this._createRootNode();t.add(e),await this._drawChildNodes(e),DiagramState.instance.debugMode&&this._drawIDLabel(e),this._drawLabel(e),this.nodeAttrs=e.attrs,this._subscribeToEvents(e),DiagramState.instance.notifyNodeChanged(e)}_drawIDLabel(t){const e=new Konva.Label({x:0,y:0,opacity:.75});e.add(new Konva.Tag({fill:"yellow",pointerDirection:"down",pointerWidth:10,pointerHeight:10})),e.add(new Konva.Text({text:this.id.toString(),fontFamily:"Calibri",fontSize:18,padding:5,fill:"black"})),"Group"===t.getClassName()?t.add(e):"Line"===t.getClassName()&&(e.x(t.points().at(2)),e.y(t.points().at(3)),t.getLayer().add(e))}_calculateLabelDrawPosition(t){return{x:0,y:-20}}_drawLabel(t){if("Group"===t.getClassName()){const e=t.findOne(".component-label");e&&e.destroy()}if(!this.label)return;const e=this._calculateLabelDrawPosition(t),n=new Konva.Text({id:"label-for."+this.id.toString(),opacity:DiagramState.instance.showLabels?1:0,name:Component.labelNodeName,text:this.label,fill:"black",x:e.x,y:e.y});"Group"===t.getClassName()?t.add(n):t.getClassName()}async reDraw(t){const e=this._getZIndex(t);this._unDrawIfNeeded(t),await this.draw(t),this.findNode(t).zIndex(e)}_getZIndex(t){const e=this.findNode(t);return e?e.zIndex():0}_unDrawIfNeeded(t){const e=this.findNode(t);e&&e.destroy()}removeFromDiagram(t){this._removeAttachedWires(t);this.findNode(t).destroy(),DiagramState.instance.removeComponentById(this.id)}findNode(t){return t.findOne("#"+this.id.toString())}_getPinNodes(t){return this.pinIds.map(e=>DiagramState.instance.getComponent(e).findNode(t))}_subscribeToEvents(t){t.on("dragend transformend",e=>{DiagramState.instance.toolMode!==TOOL_MODE_WIRE&&(this.state.nodeAttrs=e.target.attrs,this._moveAttachedWires(t))}),t.on("dragstart",e=>{DiagramState.instance.toolMode===TOOL_MODE_WIRE&&t.stopDrag()})}_createChildComponents(){}_createRootNode(){return new Konva.Group({x:this.nodeAttrs.x,y:this.nodeAttrs.y,rotation:this.nodeAttrs.rotation,scaleX:this.nodeAttrs.scaleX,scaleY:this.nodeAttrs.scaleY,skewX:this.nodeAttrs.skewX,skewY:this.nodeAttrs.skewY,draggable:this.constructor.IsDraggable,perfectDrawEnabled:this.nodeAttrs.perfectDrawEnabled||!1,name:this.constructor.name,id:this.id.toString()})}async _drawChildNodes(t){}_applyGlobalStyling(t){t.shadowColor("black"),t.shadowBlur(6),t.shadowOffset({x:3,y:3}),t.shadowOpacity(.4),t.perfectDrawEnabled(!1)}_moveAttachedWires(t){const e=t.getLayer();this.pinIds.forEach(t=>{const n=DiagramState.instance.getComponent(t).findNode(e).getAbsolutePosition();DiagramState.instance.findComponentsOfType(Wire,e=>e.startPinId===t).forEach(t=>{t.updateStartPoint([n.x,n.y]),t.reDraw(e)});DiagramState.instance.findComponentsOfType(Wire,e=>e.endPinId===t).forEach(t=>{t.updateEndPoint([n.x,n.y]),t.reDraw(e)})})}_removeAttachedWires(t){this.pinIds.forEach(e=>{DiagramState.instance.findComponentsOfType(Wire,t=>t.startPinId===e).forEach(e=>{e.removeFromDiagram(t)});DiagramState.instance.findComponentsOfType(Wire,t=>t.endPinId===e).forEach(e=>{e.removeFromDiagram(t)})})}}export class Pin extends Component{constructor(t={}){super(t),this._voltage=0,this.state.connectedPinId=null,this.state.isConnectedPinSource=!1}static get IsDraggable(){return!1}static get pinCircleNodeName(){return"pin-circle"}get connectedPinId(){return this.state.connectedPinId}_setConnectedPinId(t){this.state.connectedPinId=t}get isConnectedPinSource(){return this.state.isConnectedPinSource}_setIsConnectedPinSource(t){this.state.isConnectedPinSource=t}connectToOtherPin(t){this._setIsConnectedPinSource(!0),this._setConnectedPinId(t.id),t._setConnectedPinId(this.id),t._setIsConnectedPinSource(!1)}disconnectFromOtherPin(){if(null!==this.connectedPinId){const t=DiagramState.instance.getComponent(this.connectedPinId);t._setConnectedPinId(null),t._setIsConnectedPinSource(!1)}this._setConnectedPinId(null),this._setIsConnectedPinSource(!1)}get voltage(){return this._voltage}_setVoltage(t){this._voltage=t}resetVoltage(){this._setVoltage(0)}async _drawChildNodes(t){const e=new Konva.Circle({name:Pin.pinCircleNodeName,radius:6,stroke:"red",opacity:DiagramState.instance.showConnectors?1:0,perfectDrawEnabled:!1,strokeWidth:2});return t.add(e),Promise.resolve()}_applyGlobalStyling(t){}receiveVoltage(t){const e=t.fromWireId??null,n=t.fromPinId??null,i=t.value;if(this.voltage===i)return;if(this.voltage<0&&i>0)return;this._setVoltage(i);if(DiagramState.instance.findComponentsOfType(Wire,t=>t.id!==e&&(t.endPinId==this.id||t.startPinId==this.id)).forEach(t=>t.receiveVoltage({value:i,fromPinId:this.id})),null!==this.connectedPinId&&n!==this.connectedPinId){DiagramState.instance.getComponent(this.connectedPinId).receiveVoltage({value:i,fromWireId:e,fromPinId:this.id})}this._emit("voltageChanged",this.voltage)}hasVoltage(){return 0!==this.voltage}_drawLabel(){}}export class Wire extends Component{constructor(t={}){super(t),this.state.color=t.color||DiagramState.instance.WIRE_COLOR_DEFAULT,this._voltage=0,this._pinVoltageIsFrom=null}static get IsDraggable(){return!1}static get strokeWidth(){return 3}get startPinId(){return this.state.startPinId}get endPinId(){return this.state.endPinId}get startPoint(){return this.state.startPoint}get midPoint(){return this.state.midPoint}get endPoint(){return this.state.endPoint}get color(){return this.state.color}updateStartPoint(t){this.state.startPoint=t,this._updateMidPoint()}updateEndPoint(t){this.state.endPoint=t,this._updateMidPoint()}_updateMidPoint(){const t=Geometry.midPoint(this.startPoint,this.endPoint),e=Geometry.translationVector(this.midPoint,t),n=this._getMidPointVectorReduction(this.startPoint,this.endPoint),i=Geometry.reduceVector(e,n);this.state.midPoint=Geometry.applyVector(i,this.midPoint)}_getMidPointVectorReduction(t,e){const n=Geometry.distance(t,e);let i;return i=n>300?2:n>100?1.5:1.25,i}moveTo(t){super.moveTo(t)}get voltage(){return this._voltage}_setVoltage(t){this._voltage=t}resetVoltage(){this._setVoltage(0)}receiveVoltage(t){const e=t.fromPinId??null,n=t.value;if(this.voltage===n)return;this._setVoltage(n),this._pinVoltageIsFrom=DiagramState.instance.getComponent(e);const i=this.startPinId===e?this.endPinId:this.startPinId;DiagramState.instance.getComponent(i).receiveVoltage({value:n,fromWireId:this.id,fromPinId:e})}get pinVoltageIsFrom(){return this._pinVoltageIsFrom}hasVoltage(){return 0!==this.voltage}_createRootNode(){const t=[...this.startPoint,...this.midPoint,...this.endPoint],e=new Konva.Line({points:t,stroke:this.color,strokeWidth:Wire.strokeWidth,hitStrokeWidth:15,lineCap:"butt",lineJoin:"round",draggable:Wire.IsDraggable,tension:.7,id:this.id.toString(),name:this.constructor.name});return e.transformsEnabled("none"),e}_drawChildNodes(t){}_applyGlobalStyling(t){}changeColor(t,e){this.state.color=e,t.stroke(e),DiagramState.instance.notifyNodeChanged(t)}}export class TwoPinComponenet extends Component{constructor(t){super(t),this._setupPinConnections()}static get _pin1Position(){throw new Error("abstract method call")}static get _pin2Position(){throw new Error("abstract method call")}get pin1(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get pin2(){return DiagramState.instance.getComponent(this.pinIds.at(1))}_createChildComponents(){const t=new Pin;t.moveTo(this.constructor._pin1Position),this.pinIds.push(t.id);const e=new Pin;e.moveTo(this.constructor._pin2Position),this.pinIds.push(e.id)}async _drawChildNodes(t){this.pin1.draw(t),this.pin2.draw(t),Konva.Image.fromURL(this.constructor.ImageURL,e=>(this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex())),Promise.resolve()))}_setupPinConnections(){}}export class TwoPinPositivePassThroughComponent extends TwoPinComponenet{constructor(t){super(t),this._setupPinConnections()}_setupPinConnections(){this.pin1.on("voltageChanged",t=>{t>0&&(this.pin2.hasVoltage()||this.pin2.receiveVoltage({fromWireId:null,value:t,fromPinId:this.pin1.id}))}),this.pin2.on("voltageChanged",t=>{t>0&&(this.pin1.hasVoltage()||this.pin1.receiveVoltage({value:t,fromPinId:this.pin2.id}))})}}

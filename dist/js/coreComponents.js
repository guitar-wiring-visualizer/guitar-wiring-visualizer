/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import EventEmitter from"./eventEmitter.js";import{DiagramState,TOOL_MODE_WIRE}from"./diagram.js";export class Component extends EventEmitter{constructor(t){super(),this._state=t,t.id||(t.id=DiagramState.instance.getNewIdentity(),t.className=this.constructor.name,DiagramState.instance.registerComponent(this),t.nodeAttrs=t.nodeAttrs||{},t.pinIds=t.pinIds||[],this._createChildComponents())}get fullName(){return this.state.label?`${this.state.label} ${this.constructor.name} (${this.id})`:`${this.constructor.name} (${this.id})`}get id(){return this._state.id}get state(){return this._state}get pinIds(){return this._state.pinIds}get nodeAttrs(){return this._state.nodeAttrs}set nodeAttrs(t){this._state.nodeAttrs=t}static get ImageURL(){throw new Error("abstract method call")}static get IsDraggable(){return!0}moveTo(t){this.nodeAttrs.x=t.x,this.nodeAttrs.y=t.y}draw(t){const e=this._getPosition(),n=this._createRootNode(e);t.add(n),this._drawChildNodes(n),this.nodeAttrs=n.attrs,this._subscribeToEvents(n),DiagramState.instance.notifyNodeChanged(n)}_drawIDLabel(t){const e=new Konva.Label({x:0,y:0,opacity:.75});e.add(new Konva.Tag({fill:"yellow"})),e.add(new Konva.Text({text:this.id.toString(),fontFamily:"Calibri",fontSize:18,padding:5,fill:"black"})),"Group"===t.getClassName()&&t.add(e)}reDraw(t){this._unDrawIfNeeded(t),this.draw(t)}_unDrawIfNeeded(t){const e=this.findNode(t);e&&e.destroy()}removeFromDiagram(t){const e=this.findNode(t);e.destroy(),DiagramState.instance.notifyNodeChanged(e),DiagramState.instance.removeComponentById(this.id)}findNode(t){return t.findOne("#"+this.id.toString())}_getPosition(){return{x:this.nodeAttrs.x,y:this.nodeAttrs.y}}_getPinNodes(t){return this.pinIds.map(e=>DiagramState.instance.getComponent(e).findNode(t))}_subscribeToEvents(t){t.on("dragend transformend",e=>{this.state.nodeAttrs=t.attrs,this._moveAttachedWires(t)}),t.on("dragstart",e=>{DiagramState.instance.toolMode===TOOL_MODE_WIRE&&t.stopDrag()})}_createChildComponents(){}_createRootNode(){return new Konva.Group({x:this.nodeAttrs.x,y:this.nodeAttrs.y,draggable:this.constructor.IsDraggable,name:this.constructor.name,id:this.id.toString()})}_drawChildNodes(t){}_applyGlobalStyling(t){t.shadowColor("black"),t.shadowBlur(6),t.shadowOffset({x:3,y:3}),t.shadowOpacity(.4)}_moveAttachedWires(t){const e=t.getLayer();this.pinIds.forEach(t=>{const n=DiagramState.instance.getComponent(t).findNode(e).getAbsolutePosition();DiagramState.instance.findComponentsOfType(Wire,e=>e.startPinId===t).forEach(t=>{t.updateStartPoint([n.x,n.y]),t.reDraw(e)});DiagramState.instance.findComponentsOfType(Wire,e=>e.endPinId===t).forEach(t=>{t.updateEndPoint([n.x,n.y]),t.reDraw(e)})})}}export class Pin extends Component{constructor(t={}){super(t),this._voltage=0,this.state.connectedPinId=null,this.state.isConnectedPinSource=!1}static get IsDraggable(){return!1}get connectedPinId(){return this.state.connectedPinId}_setConnectedPinId(t){this.state.connectedPinId=t}get isConnectedPinSource(){return this.state.isConnectedPinSource}_setIsConnectedPinSource(t){this.state.isConnectedPinSource=t}connectToOtherPin(t){this._setIsConnectedPinSource(!0),this._setConnectedPinId(t.id),t._setConnectedPinId(this.id),t._setIsConnectedPinSource(!1)}disconnectFromOtherPin(){if(null!==this.connectedPinId){const t=DiagramState.instance.getComponent(this.connectedPinId);t._setConnectedPinId(null),t._setIsConnectedPinSource(!1)}this._setConnectedPinId(null),this._setIsConnectedPinSource(!1)}get voltage(){return this._voltage}_setVoltage(t){this._voltage=t}resetVoltage(){this._setVoltage(0)}_drawChildNodes(t){const e=new Konva.Circle({radius:6,stroke:"red",opacity:DiagramState.instance.showConnectors?1:0,strokeWidth:2});t.add(e)}_applyGlobalStyling(t){}receiveVoltage(t,e,n=null){this._setVoltage(e);if(DiagramState.instance.findComponentsOfType(Wire,e=>e.id!==t&&(e.endPinId==this.id||e.startPinId==this.id)).forEach(t=>t.receiveVoltage(this.id,e)),null!==this.connectedPinId&&n!==this.connectedPinId){DiagramState.instance.getComponent(this.connectedPinId).receiveVoltage(t,e,this.id)}this._emit("voltageChanged",this.voltage)}hasVoltage(){return 0!==this.voltage}}export class Wire extends Component{constructor(t={}){super(t),this.state.color=t.color||DiagramState.instance.WIRE_COLOR_DEFAULT,this._voltage=0,this._pinVoltageIsFrom=null}static get IsDraggable(){return!1}get startPinId(){return this.state.startPinId}get endPinId(){return this.state.endPinId}get startPoint(){return this.state.startPoint}get midPoint(){return this.state.midPoint}get endPoint(){return this.state.endPoint}get color(){return this.state.color}updateStartPoint(t){this.state.startPoint=t}updateEndPoint(t){this.state.endPoint=t}moveTo(t){super.moveTo(t)}get voltage(){return this._voltage}_setVoltage(t){this._voltage=t}resetVoltage(){this._setVoltage(0)}receiveVoltage(t,e){this._setVoltage(e),this._pinVoltageIsFrom=DiagramState.instance.getComponent(t);const n=this.startPinId===t?this.endPinId:this.startPinId;DiagramState.instance.getComponent(n).receiveVoltage(this.id,e,t)}get pinVoltageIsFrom(){return this._pinVoltageIsFrom}hasVoltage(){return 0!==this.voltage}_createRootNode(t){const e=[...this.startPoint,...this.midPoint,...this.endPoint],n=new Konva.Line({points:e,stroke:this.color,strokeWidth:5,lineCap:"butt",lineJoin:"round",draggable:Wire.IsDraggable,tension:.7,id:this.id.toString(),name:this.constructor.name});return n.transformsEnabled("none"),n}_drawChildNodes(t){}_applyGlobalStyling(t){}changeColor(t,e){this.state.color=e,t.stroke(e)}}export class TwoPinPassThroughComponenet extends Component{constructor(t){super(t)}static get _pin1Position(){throw new Error("abstract method call")}static get _pin2Position(){throw new Error("abstract method call")}get pin1(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get pin2(){return DiagramState.instance.getComponent(this.pinIds.at(1))}_createChildComponents(){const t=new Pin;t.moveTo(this.constructor._pin1Position),this.pinIds.push(t.id);const e=new Pin;e.moveTo(this.constructor._pin2Position),this.pinIds.push(e.id)}_drawChildNodes(t){this.pin1.draw(t),this.pin2.draw(t),Konva.Image.fromURL(this.constructor.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))})}}

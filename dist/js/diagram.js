/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{componentClassMap}from"./components.js";import EventEmitter from"./eventEmitter.js";import{CompressionType,getCompressor}from"./compression.js";export const TOOL_MODE_SELECT="select";export const TOOL_MODE_WIRE="wire";export const WIRE_COLOR_RED="red";export const WIRE_COLOR_BLACK="black";export const WIRE_COLOR_GREEN="green";export const WIRE_COLOR_YELLOW="yellow";export const WIRE_COLOR_BLUE="blue";export const WIRE_COLOR_DEFAULT="black";export class DiagramState extends EventEmitter{constructor(t={}){if(super(),DiagramState.instance)return DiagramState.instance;this._lastIssuedId=0,this._componenetMap={},this.showConnectors=!1,this.showActuators=!0,this.showInternals=!0,this.showLabels=!0,this.toolMode="select",this.wireToolColor="black",this.debugMode=t.debugMode||!1,DiagramState.instance=this}getNewIdentity(){return++this._lastIssuedId}registerComponent(t){this._addToComponentMap(t.id,t),this._emit("componentAdded",t.id)}notifyNodeChanged(t){"Wire"===t.name()&&this._emit("wireChanged",t),["DPDTOnOn","DPDTOnOffOn","DPDTOnOnOn","Potentiometer","ThreeWayToggle"].includes(t.name())&&this._emit("switchChanged",t)}getComponent(t){return this._componenetMap[parseInt(t,10)]}_addToComponentMap(t,e){this._componenetMap[t]=e}_allComponentInstances(){return Object.values(this._componenetMap)}findComponents(t){return this._allComponentInstances().filter(t)}findComponentsOfType(t,e){return this.findComponents(n=>n.constructor===t&&e(n))}removeComponentById(t){this._removeComponentInternal(t),this._emit("componentRemoved",t)}_removeComponentInternal(t){const e=this.getComponent(t);e&&(e.pinIds?.forEach(t=>{this._removeComponentInternal(t)}),delete this._componenetMap[e.id])}removeAllComponents(){Object.keys(this._componenetMap).forEach(t=>{this._removeComponentInternal(t)}),this._emit("allComponentsRemoved")}async serializeState(){if(0===this._allComponentInstances().length)return"";const t={componentStates:this._allComponentInstances().map(t=>t.state)},e=await getCompressor(CompressionType.BROTLI);return await e.compress(JSON.stringify(t))}async loadState(t){let e,n=await getCompressor(CompressionType.BROTLI);try{e=await n.decompress(t)}catch(o){n=await getCompressor(CompressionType.GZIP),e=await n.decompress(t)}const o=JSON.parse(e),s=[];o.componentStates.forEach(t=>{const e=t.className;if("Pin"===e){s.push(t.id);const n=new componentClassMap[e](t);this.registerComponent(n)}}),o.componentStates.forEach(t=>{const e=t.className;if("Pin"!==e){s.push(t.id);const n=new componentClassMap[e](t);this.registerComponent(n)}}),this._lastIssuedId=s.sort((t,e)=>e-t).at(0)}drawAll(t){this._allComponentInstances().filter(t=>"Pin"!==t.constructor.name).forEach(e=>e.draw(t))}_findAllPickups(){return this.findComponents(t=>t.can("pickUp"))}_findAllResetVoltageComponents(){return this.findComponents(t=>t.can("resetVoltage"))}_findAllJacks(){return this.findComponents(t=>t.can("jackIn"))}start(){this._findAllPickups().forEach(t=>t.pickUp()),this._findAllJacks().forEach(t=>t.jackIn())}stop(){this._findAllResetVoltageComponents().forEach(t=>{t.resetVoltage()}),this._findAllPickups().forEach(t=>t.stopPickingUp())}}

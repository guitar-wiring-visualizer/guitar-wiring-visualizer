/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{componentClassMap}from"./components.js";import EventEmitter from"./eventEmitter.js";export const TOOL_MODE_SELECT="select";export const TOOL_MODE_WIRE="wire";export const WIRE_COLOR_RED="red";export const WIRE_COLOR_BLACK="black";export const WIRE_COLOR_GREEN="green";export const WIRE_COLOR_YELLOW="yellow";export const WIRE_COLOR_BLUE="blue";export const WIRE_COLOR_DEFAULT="black";export class DiagramState extends EventEmitter{constructor(){if(super(),DiagramState.instance)return DiagramState.instance;this._lastIssuedId=0,this._componenetMap={},this.showConnectors=!1,this.toolMode="select",this.wireToolColor="black",DiagramState.instance=this}getNewIdentity(){return++this._lastIssuedId}registerComponent(e){this._addToComponentMap(e.id,e)}notifyNodeChanged(e){"Wire"===e.name()&&this._emit("wireChanged",e),["DPDTOnOn","DPDTOnOffOn","DPDTOnOnOn"].includes(e.name())&&this._emit("switchChanged",e)}getComponent(e){return this._componenetMap[parseInt(e,10)]}_addToComponentMap(e,t){this._componenetMap[e]=t}_allComponentInstances(){return Object.values(this._componenetMap)}findComponents(e){return this._allComponentInstances().filter(e)}findComponentsOfType(e,t){return this.findComponents(n=>n.constructor===e&&t(n))}removeComponentById(e){const t=this.getComponent(e);t.pinIds&&t.pinIds.forEach(e=>{this.removeComponentById(e)}),delete this._componenetMap[t.id]}async serializeState(){if(0===this._allComponentInstances().length)return"";const e={componentStates:this._allComponentInstances().map(e=>e.state)};return await Compressor.compress(JSON.stringify(e))}async loadState(e){const t=await Compressor.decompress(e),n=JSON.parse(t),o=[];n.componentStates.forEach(e=>{const t=e.className;if("Pin"===t){o.push(e.id);const n=new componentClassMap[t](e);this.registerComponent(n)}}),n.componentStates.forEach(e=>{const t=e.className;if("Pin"!==t){o.push(e.id);const n=new componentClassMap[t](e);this.registerComponent(n)}}),this._lastIssuedId=o.sort((e,t)=>t-e).at(0)}drawAll(e){this._allComponentInstances().filter(e=>"Pin"!==e.constructor.name).forEach(t=>t.draw(e))}_findAllPickups(){return this.findComponents(e=>"function"==typeof e.pickUp)}_findAllResetVoltageComponents(){return this.findComponents(e=>"function"==typeof e.resetVoltage)}start(){this._findAllPickups().forEach(e=>e.pickUp())}stop(){this._findAllResetVoltageComponents().forEach(e=>{e.resetVoltage()})}}class Compressor{static async compress(e){const t=(new TextEncoder).encode(e),n=new CompressionStream("gzip"),o=n.writable.getWriter();o.write(t),o.close();return(e=>new Promise((t,n)=>{const o=new FileReader;o.onloadend=()=>t(o.result.split(",")[1]),o.readAsDataURL(e)}))(await new Response(n.readable).blob())}static async decompress(e){const t=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),n=new DecompressionStream("gzip"),o=n.writable.getWriter();o.write(t),o.close();const s=await new Response(n.readable).arrayBuffer();return(new TextDecoder).decode(s)}}

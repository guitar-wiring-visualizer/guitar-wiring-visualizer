/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{componentClassMap}from"./components.js";import{CompressionType,getCompressor}from"./compression.js";export const ToolMode=Object.freeze({Select:0,Wire:1});export const WireColors=Object.freeze({Black:"black",Red:"red",Yellow:"yellow",Green:"green",Blue:"blue"});export const WIRE_COLOR_DEFAULT=WireColors.Black;export class DiagramState{constructor(e={}){if(DiagramState.instance)return DiagramState.instance;this._lastIssuedId=0,this._componenetMap={},this.showConnectors=!1,this.showActuators=!0,this.showInternals=!0,this.showLabels=!0,this.toolMode=ToolMode.Select,this.wireToolColor=WIRE_COLOR_DEFAULT,this.debugMode=e.debugMode||!1,DiagramState.instance=this}getNewIdentity(){return++this._lastIssuedId}registerComponent(e){this._addToComponentMap(e.id,e)}getComponent(e){return this._componenetMap[parseInt(e,10)]}_addToComponentMap(e,t){this._componenetMap[e]=t}_allComponentInstances(){return Object.values(this._componenetMap)}findComponents(e){return this._allComponentInstances().filter(e)}findComponentsOfType(e,t){return this.findComponents(o=>o.constructor===e&&t(o))}removeComponentById(e){this._removeComponentInternal(e)}_removeComponentInternal(e){const t=this.getComponent(e);t&&(t.pinIds?.forEach(e=>{this._removeComponentInternal(e)}),delete this._componenetMap[t.id])}removeAllComponents(){Object.keys(this._componenetMap).forEach(e=>{this._removeComponentInternal(e)})}async serializeState(){if(0===this._allComponentInstances().length)return"";const e={componentStates:this._allComponentInstances().map(e=>e.state)},t=await getCompressor(CompressionType.BROTLI);return await t.compress(JSON.stringify(e))}async loadState(e){let t,o=await getCompressor(CompressionType.BROTLI);try{t=await o.decompress(e)}catch(n){o=await getCompressor(CompressionType.GZIP),t=await o.decompress(e)}const n=JSON.parse(t),s=[];n.componentStates.forEach(e=>{const t=e.className;if("Pin"===t){s.push(e.id);const o=new componentClassMap[t](e);this.registerComponent(o)}}),n.componentStates.forEach(e=>{const t=e.className;if("Pin"!==t){s.push(e.id);const o=new componentClassMap[t](e);this.registerComponent(o)}}),this._lastIssuedId=s.sort((e,t)=>t-e).at(0)}drawAll(e){this._allComponentInstances().filter(e=>"Pin"!==e.constructor.name).forEach(t=>t.draw(e))}_findAllPickups(){return this.findComponents(e=>e.can("pickUp"))}_findAllResetVoltageComponents(){return this.findComponents(e=>e.can("resetVoltage"))}_findAllJacks(){return this.findComponents(e=>e.can("jackIn"))}start(){this._findAllPickups().forEach(e=>e.pickUp()),this._findAllJacks().forEach(e=>e.jackIn())}stop(){this._findAllResetVoltageComponents().forEach(e=>{e.resetVoltage()}),this._findAllPickups().forEach(e=>e.stopPickingUp())}}

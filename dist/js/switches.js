/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState}from"./diagram.js";import{Component,Pin}from"./coreComponents.js";class Switch extends Component{constructor(t={}){super(t),this.state.actuatorState=this.state.actuatorState||0,this._updatePinConnections()}static get actuatorNodeName(){return"switch-actuator"}static get pinConnectionNodeName(){return"switch-pin-connection"}get actuatorState(){return this.state.actuatorState}_getValidActuatorStates(){return[0,1]}_setActuatorState(t){if(!this._getValidActuatorStates().includes(t))throw new Error(`invalid actuator state ${t}`);this.state.actuatorState=t}flip(t){this._flipActuatorAndSetState(),this._reDrawActuator(t),this._updatePinConnections(),this._reDrawPinConnections(t),DiagramState.instance.notifyNodeChanged(t)}_flipActuatorAndSetState(){throw new Error("abstract method call")}_drawActuator(t){}_reDrawActuator(t){t.findOne("."+Switch.actuatorNodeName).destroy(),this._drawActuator(t)}_updatePinConnections(){}_drawPinConnections(t){}_getAllPins(){return[]}_reDrawPinConnections(t){t.find("."+Switch.pinConnectionNodeName).forEach(t=>{t.destroy()}),this._drawPinConnections(t)}}export class ThreeWayToggle extends Switch{constructor(t={}){super(t)}static get ImageURL(){return"/img/toggle-switch-back.svg"}get pin1(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get pin2(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get pin3(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get pin4(){return DiagramState.instance.getComponent(this.pinIds.at(3))}get groundPin(){return DiagramState.instance.getComponent(this.pinIds.at(4))}_getValidActuatorStates(){return[-1,0,1]}_createChildComponents(){const t=new Pin;this.pinIds.push(t.id),t.moveTo({x:2,y:14});const n=new Pin;this.pinIds.push(n.id),n.moveTo({x:2,y:44});const i=new Pin;this.pinIds.push(i.id),i.moveTo({x:122,y:20});const e=new Pin;this.pinIds.push(e.id),e.moveTo({x:122,y:38});const a=new Pin;this.pinIds.push(a.id),a.moveTo({x:17,y:29})}async _drawChildNodes(t){this.pin1.draw(t),this.pin2.draw(t),this.pin3.draw(t),this.pin4.draw(t),this.groundPin.draw(t),Konva.Image.fromURL(this.constructor.ImageURL,n=>(this._applyGlobalStyling(n),t.add(n),this._getPinNodes(t).forEach(t=>t.zIndex(n.zIndex())),this._drawActuator(t),this._drawPinConnections(t),Promise.resolve()))}_updatePinConnections(){this.pin1.disconnectFromOtherPin(),this.pin2.disconnectFromOtherPin(),-1===this.actuatorState?this.pin1.connectToOtherPin(this.pin3):0===this.actuatorState?(this.pin1.connectToOtherPin(this.pin3),this.pin2.connectToOtherPin(this.pin4)):1===this.actuatorState&&this.pin2.connectToOtherPin(this.pin4)}_getActuatorImageURLForState(){return-1===this.actuatorState?"/img/bat-small-left.svg":0===this.actuatorState?"/img/bat-small-center.svg":1===this.actuatorState?"/img/bat-small-right.svg":void 0}_flipActuatorAndSetState(){let t;-1===this.actuatorState?t=0:0===this.actuatorState?t=-1===this._prevActuatorState?1:-1:1===this.actuatorState&&(t=0),this._prevActuatorState=this.actuatorState,this._setActuatorState(t)}_drawActuator(t){Konva.Image.fromURL(this._getActuatorImageURLForState(),n=>{n.position({x:43,y:-35}),n.name(Switch.actuatorNodeName),n.opacity(DiagramState.instance.showActuators?1:0),this._applyGlobalStyling(n),t.add(n)})}_getAllPins(){return[this.pin1,this.pin2,this.pin3,this.pin4,this.groundPin]}_drawPinConnections(t){this._getAllPins().forEach(n=>{if(null!==n.connectedPinId&&n.isConnectedPinSource){const i=n.findNode(t).position(),e=DiagramState.instance.getComponent(n.connectedPinId).findNode(t).position(),a=new Konva.Line({name:Switch.pinConnectionNodeName,opacity:DiagramState.instance.showInternals?1:0,strokeWidth:2,stroke:"#a6a6a6",draggable:!1,perfectDrawEnable:!1,points:[i.x,i.y,e.x,e.y]});t.add(a)}})}_calculateLabelDrawPosition(t){return{x:25,y:70}}}class DPDTSwitch extends Switch{constructor(t={}){super(t)}static get _pinsStartAtX(){return 10}static get _pinsStartAtY(){return 9}_calculateLabelDrawPosition(t){return{x:50,y:20}}get pin6(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get pin3(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get pin5(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get pin2(){return DiagramState.instance.getComponent(this.pinIds.at(3))}get pin4(){return DiagramState.instance.getComponent(this.pinIds.at(4))}get pin1(){return DiagramState.instance.getComponent(this.pinIds.at(5))}_createChildComponents(){for(let t=0;t<3;t++)for(let n=0;n<2;n++){const i=new Pin;this.pinIds.push(i.id),i.moveTo({x:DPDTSwitch._pinsStartAtX+22*n,y:DPDTSwitch._pinsStartAtY+15*t})}}async _drawChildNodes(t){this.pin1.draw(t),this.pin2.draw(t),this.pin3.draw(t),this.pin4.draw(t),this.pin5.draw(t),this.pin6.draw(t),Konva.Image.fromURL(this.constructor.ImageURL,n=>(this._applyGlobalStyling(n),t.add(n),this._getPinNodes(t).forEach(t=>t.zIndex(n.zIndex())),this._drawActuator(t),this._drawPinConnections(t),Promise.resolve()))}_getActuatorImageURLForState(){throw new Error("abstract method call")}_drawActuator(t){Konva.Image.fromURL(this._getActuatorImageURLForState(),n=>{n.position({x:0,y:-35}),n.name(Switch.actuatorNodeName),n.opacity(DiagramState.instance.showActuators?1:0),this._applyGlobalStyling(n),t.add(n)})}_getAllPins(){return[this.pin1,this.pin2,this.pin3,this.pin4,this.pin5,this.pin6]}_drawPinConnections(t){this._getAllPins().forEach(n=>{if(null!==n.connectedPinId&&n.isConnectedPinSource){const i=n.findNode(t).position(),e=DiagramState.instance.getComponent(n.connectedPinId).findNode(t).position(),a=new Konva.Line({name:Switch.pinConnectionNodeName,opacity:DiagramState.instance.showInternals?1:0,strokeWidth:5,stroke:"#696969",draggable:!1,perfectDrawEnable:!1,points:[i.x,i.y,e.x,e.y]});t.add(a)}})}}export class DPDTOnOn extends DPDTSwitch{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-blue.svg"}_getActuatorImageURLForState(){return 0===this.actuatorState?"/img/bat-small-left.svg":"/img/bat-small-right.svg"}_flipActuatorAndSetState(){this._setActuatorState(0===this.actuatorState?1:0)}_updatePinConnections(){0===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin1),this.pin5.connectToOtherPin(this.pin4)):(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin6))}}class DPDT3Position extends DPDTSwitch{constructor(t={}){super(t),this._prevActuatorState=-1===this.actuatorState||1===this.actuatorState?0:-1}_getValidActuatorStates(){return[-1,0,1]}_getActuatorImageURLForState(){return-1===this.actuatorState?"/img/bat-small-left.svg":0===this.actuatorState?"/img/bat-small-center.svg":1===this.actuatorState?"/img/bat-small-right.svg":void 0}_flipActuatorAndSetState(){let t;-1===this.actuatorState?t=0:0===this.actuatorState?t=-1===this._prevActuatorState?1:-1:1===this.actuatorState&&(t=0),this._prevActuatorState=this.actuatorState,this._setActuatorState(t)}}export class DPDTOnOffOn extends DPDT3Position{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-purple.svg"}_updatePinConnections(){-1===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin6)):0===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin()):1===this.actuatorState&&(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin1),this.pin5.connectToOtherPin(this.pin4))}}export class DPDTOnOnOn extends DPDT3Position{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-red.svg"}_updatePinConnections(){-1===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin6)):0===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin4)):1===this.actuatorState&&(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin1),this.pin5.connectToOtherPin(this.pin4))}}

/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState}from"./diagram.js";import{EventDispatcher,Events}from"./events.js";import{Component,Pin}from"./coreComponents.js";class Switch extends Component{constructor(t={}){super(t),this.state.actuatorState=this.state.actuatorState||0,this._updatePinConnections()}static get actuatorNodeName(){return"switch-actuator"}static get pinConnectionNodeName(){return"switch-pin-connection"}get actuatorState(){return this.state.actuatorState}_getValidActuatorStates(){return[0,1]}_setActuatorState(t){if(!this._getValidActuatorStates().includes(t))throw new Error(`invalid actuator state ${t}`);this.state.actuatorState=t}flip(t){this._flipActuatorAndSetState(),this._reDrawActuator(t),this._updatePinConnections(),this._reDrawPinConnections(t),EventDispatcher.instance.dispatch(Events.SwitchFlipped,this._createBaseEventArgs())}_flipActuatorAndSetState(){throw new Error("abstract method call")}_drawActuator(t){}_reDrawActuator(t){t.findOne("."+Switch.actuatorNodeName).destroy(),this._drawActuator(t)}_updatePinConnections(){}_drawPinConnections(t){}_getAllPins(){return[]}_reDrawPinConnections(t){t.find("."+Switch.pinConnectionNodeName).forEach(t=>{t.destroy()}),this._drawPinConnections(t)}}export class EightPinBladeSwitch extends Switch{constructor(t={}){super(t)}get pinA1(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get pinA2(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get pinA3(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get pinA0(){return DiagramState.instance.getComponent(this.pinIds.at(3))}get pinB0(){return DiagramState.instance.getComponent(this.pinIds.at(4))}get pinB1(){return DiagramState.instance.getComponent(this.pinIds.at(5))}get pinB2(){return DiagramState.instance.getComponent(this.pinIds.at(6))}get pinB3(){return DiagramState.instance.getComponent(this.pinIds.at(7))}static get ImageURL(){return"/img/blade-switch.svg"}static get APinsMarkerColor(){return"#6d87ce"}static get BPinsMarkerColor(){return"#cbc25c"}_getAllPins(){return[this.pinA0,this.pinA1,this.pinA2,this.pinA3,this.pinB0,this.pinB1,this.pinB2,this.pinB3]}_createChildComponents(){const t=new Pin;this.pinIds.push(t.id),t.moveTo({x:10,y:30});const i=new Pin;this.pinIds.push(i.id),i.moveTo({x:9,y:70});const n=new Pin;this.pinIds.push(n.id),n.moveTo({x:9,y:110});const e=new Pin;this.pinIds.push(e.id),e.moveTo({x:9,y:149});const s=new Pin;this.pinIds.push(s.id),s.moveTo({x:49,y:16});const a=new Pin;this.pinIds.push(a.id),a.moveTo({x:49,y:56});const o=new Pin;this.pinIds.push(o.id),o.moveTo({x:49,y:95});const r=new Pin;this.pinIds.push(r.id),r.moveTo({x:49,y:134})}async _drawChildNodes(t){this.pinA0.draw(t),this.pinA1.draw(t),this.pinA2.draw(t),this.pinA3.draw(t),this.pinB0.draw(t),this.pinB1.draw(t),this.pinB2.draw(t),this.pinB3.draw(t),Konva.Image.fromURL(this.constructor.ImageURL,i=>(this._applyGlobalStyling(i),t.add(i),this._getPinNodes(t).forEach(t=>t.zIndex(i.zIndex())),this._drawActuator(t),this._drawPinConnections(t),Promise.resolve()))}_drawActuator(t){Konva.Image.fromURL(this._getActuatorImageURLForState(),i=>{i.position({x:70,y:-30}),i.name(Switch.actuatorNodeName),i.opacity(DiagramState.instance.showActuators?1:0),this._applyGlobalStyling(i),t.add(i)})}_drawPinMarker(t,i,n){const e=t.findNode(n).position(),s=new Konva.Rect({name:Switch.pinConnectionNodeName,opacity:DiagramState.instance.showInternals?.6:0,width:16,height:16,x:e.x-8,y:e.y-8,fill:i,draggable:!1,perfectDrawEnable:!1});n.add(s)}_calculateLabelDrawPosition(t){return{x:0,y:-20}}}export class ThreeWayBlade extends EightPinBladeSwitch{constructor(t={}){super(t)}_getValidActuatorStates(){return[0,1,2]}_flipActuatorAndSetState(){let t;0===this.actuatorState?t=1:1===this.actuatorState?t=0===this._prevActuatorState?2:0:2===this.actuatorState&&(t=1),this._prevActuatorState=this.actuatorState,this._setActuatorState(t)}_getActuatorImageURLForState(){return`/img/blade-3-${this.actuatorState}.svg`}_updatePinConnections(){switch(this.pinA0.disconnectFromOtherPin(),this.pinB0.disconnectFromOtherPin(),this.actuatorState){case 0:this.pinA0.connectToOtherPin(this.pinA3),this.pinB0.connectToOtherPin(this.pinB3);break;case 1:this.pinA0.connectToOtherPin(this.pinA2),this.pinB0.connectToOtherPin(this.pinB2);break;case 2:this.pinA0.connectToOtherPin(this.pinA1),this.pinB0.connectToOtherPin(this.pinB1)}}_drawPinConnections(t){this._drawConnectedPinMarkers(this.pinA0,this.constructor.APinsMarkerColor,t),this._drawConnectedPinMarkers(this.pinB0,this.constructor.BPinsMarkerColor,t)}_drawConnectedPinMarkers(t,i,n){if(null!==t.connectedPinId){this._drawPinMarker(t,i,n);const e=DiagramState.instance.getComponent(t.connectedPinId);this._drawPinMarker(e,i,n)}}}export class FiveWayBlade extends EightPinBladeSwitch{constructor(t={}){super(t)}_getValidActuatorStates(){return[0,1,2,3,4]}_flipActuatorAndSetState(){this._actuatorAsc=this._actuatorAsc??!0;let t=Math.min(4,Math.max(0,this._actuatorAsc?this.actuatorState+1:this.actuatorState-1));0===t&&(this._actuatorAsc=!0),4===t&&(this._actuatorAsc=!1),this._setActuatorState(t)}_getActuatorImageURLForState(){return`/img/blade-5-${this.actuatorState}.svg`}_connectBothPins(t,i){this._disconnectFunctions=this._disconnectFunctions??[],this._connectPin(t,i),this._connectPin(i,t)}_connectPin(t,i){const n=t.on(Events.VoltageChanged,n=>{n.source?.fromPinId!==i.id&&i.receiveVoltage({value:n.currentVoltage,fromPinId:t.id})});this._disconnectFunctions.push(n)}_disconnectAllPins(){this._disconnectFunctions=this._disconnectFunctions??[],this._disconnectFunctions.forEach((t,i)=>{t()}),this._disconnectFunctions=[]}_updatePinConnections(){switch(this._disconnectAllPins(),this.actuatorState){case 0:this._connectBothPins(this.pinA0,this.pinA3),this._connectBothPins(this.pinB0,this.pinB3);break;case 1:this._connectBothPins(this.pinA0,this.pinA2),this._connectBothPins(this.pinA2,this.pinA3),this._connectBothPins(this.pinB0,this.pinB2),this._connectBothPins(this.pinB2,this.pinB3);break;case 2:this._connectBothPins(this.pinA0,this.pinA2),this._connectBothPins(this.pinB0,this.pinB2);break;case 3:this._connectBothPins(this.pinA0,this.pinA2),this._connectBothPins(this.pinA2,this.pinA1),this._connectBothPins(this.pinB0,this.pinB1),this._connectBothPins(this.pinB1,this.pinB2);break;case 4:this._connectBothPins(this.pinA0,this.pinA1),this._connectBothPins(this.pinB0,this.pinB1)}}_drawPinConnections(t){const i=this.constructor.APinsMarkerColor,n=this.constructor.BPinsMarkerColor;switch(this._drawPinMarker(this.pinA0,i,t),this._drawPinMarker(this.pinB0,n,t),this.actuatorState){case 0:this._drawPinMarker(this.pinA3,i,t),this._drawPinMarker(this.pinB3,n,t);break;case 1:this._drawPinMarker(this.pinA2,i,t),this._drawPinMarker(this.pinA3,i,t),this._drawPinMarker(this.pinB2,n,t),this._drawPinMarker(this.pinB3,n,t);break;case 2:this._drawPinMarker(this.pinA2,i,t),this._drawPinMarker(this.pinB2,n,t);break;case 3:this._drawPinMarker(this.pinA1,i,t),this._drawPinMarker(this.pinA2,i,t),this._drawPinMarker(this.pinB1,n,t),this._drawPinMarker(this.pinB2,n,t);break;case 4:this._drawPinMarker(this.pinA1,i,t),this._drawPinMarker(this.pinB1,n,t)}}}export class ThreeWayToggle extends Switch{constructor(t={}){super(t)}static get ImageURL(){return"/img/toggle-switch-back.svg"}get pin1(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get pin2(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get pin3(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get pin4(){return DiagramState.instance.getComponent(this.pinIds.at(3))}get groundPin(){return DiagramState.instance.getComponent(this.pinIds.at(4))}_getValidActuatorStates(){return[-1,0,1]}_createChildComponents(){const t=new Pin;this.pinIds.push(t.id),t.moveTo({x:2,y:14});const i=new Pin;this.pinIds.push(i.id),i.moveTo({x:2,y:44});const n=new Pin;this.pinIds.push(n.id),n.moveTo({x:122,y:20});const e=new Pin;this.pinIds.push(e.id),e.moveTo({x:122,y:38});const s=new Pin;this.pinIds.push(s.id),s.moveTo({x:17,y:29})}async _drawChildNodes(t){this.pin1.draw(t),this.pin2.draw(t),this.pin3.draw(t),this.pin4.draw(t),this.groundPin.draw(t),Konva.Image.fromURL(this.constructor.ImageURL,i=>(this._applyGlobalStyling(i),t.add(i),this._getPinNodes(t).forEach(t=>t.zIndex(i.zIndex())),this._drawActuator(t),this._drawPinConnections(t),Promise.resolve()))}_updatePinConnections(){this.pin1.disconnectFromOtherPin(),this.pin2.disconnectFromOtherPin(),-1===this.actuatorState?this.pin1.connectToOtherPin(this.pin3):0===this.actuatorState?(this.pin1.connectToOtherPin(this.pin3),this.pin2.connectToOtherPin(this.pin4)):1===this.actuatorState&&this.pin2.connectToOtherPin(this.pin4)}_getActuatorImageURLForState(){return-1===this.actuatorState?"/img/bat-small-left.svg":0===this.actuatorState?"/img/bat-small-center.svg":1===this.actuatorState?"/img/bat-small-right.svg":void 0}_flipActuatorAndSetState(){let t;-1===this.actuatorState?t=0:0===this.actuatorState?t=-1===this._prevActuatorState?1:-1:1===this.actuatorState&&(t=0),this._prevActuatorState=this.actuatorState,this._setActuatorState(t)}_drawActuator(t){Konva.Image.fromURL(this._getActuatorImageURLForState(),i=>{i.position({x:43,y:-35}),i.name(Switch.actuatorNodeName),i.opacity(DiagramState.instance.showActuators?1:0),this._applyGlobalStyling(i),t.add(i)})}_getAllPins(){return[this.pin1,this.pin2,this.pin3,this.pin4,this.groundPin]}_drawPinConnections(t){this._getAllPins().forEach(i=>{if(null!==i.connectedPinId&&i.isConnectedPinSource){const n=i.findNode(t).position(),e=DiagramState.instance.getComponent(i.connectedPinId).findNode(t).position(),s=new Konva.Line({name:Switch.pinConnectionNodeName,opacity:DiagramState.instance.showInternals?1:0,strokeWidth:2,stroke:"#a6a6a6",draggable:!1,perfectDrawEnable:!1,points:[n.x,n.y,e.x,e.y]});t.add(s)}})}_calculateLabelDrawPosition(t){return{x:25,y:70}}}class DPDTSwitch extends Switch{constructor(t={}){super(t)}static get _pinsStartAtX(){return 10}static get _pinsStartAtY(){return 9}_calculateLabelDrawPosition(t){return{x:50,y:20}}get pin6(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get pin3(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get pin5(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get pin2(){return DiagramState.instance.getComponent(this.pinIds.at(3))}get pin4(){return DiagramState.instance.getComponent(this.pinIds.at(4))}get pin1(){return DiagramState.instance.getComponent(this.pinIds.at(5))}_createChildComponents(){for(let t=0;t<3;t++)for(let i=0;i<2;i++){const n=new Pin;this.pinIds.push(n.id),n.moveTo({x:DPDTSwitch._pinsStartAtX+22*i,y:DPDTSwitch._pinsStartAtY+15*t})}}async _drawChildNodes(t){this.pin1.draw(t),this.pin2.draw(t),this.pin3.draw(t),this.pin4.draw(t),this.pin5.draw(t),this.pin6.draw(t),Konva.Image.fromURL(this.constructor.ImageURL,i=>(this._applyGlobalStyling(i),t.add(i),this._getPinNodes(t).forEach(t=>t.zIndex(i.zIndex())),this._drawActuator(t),this._drawPinConnections(t),Promise.resolve()))}_getActuatorImageURLForState(){throw new Error("abstract method call")}_drawActuator(t){Konva.Image.fromURL(this._getActuatorImageURLForState(),i=>{i.position({x:0,y:-35}),i.name(Switch.actuatorNodeName),i.opacity(DiagramState.instance.showActuators?1:0),this._applyGlobalStyling(i),t.add(i)})}_getAllPins(){return[this.pin1,this.pin2,this.pin3,this.pin4,this.pin5,this.pin6]}_drawPinConnections(t){this._getAllPins().forEach(i=>{if(null!==i.connectedPinId&&i.isConnectedPinSource){const n=i.findNode(t).position(),e=DiagramState.instance.getComponent(i.connectedPinId).findNode(t).position(),s=new Konva.Line({name:Switch.pinConnectionNodeName,opacity:DiagramState.instance.showInternals?1:0,strokeWidth:5,stroke:"#696969",draggable:!1,perfectDrawEnable:!1,points:[n.x,n.y,e.x,e.y]});t.add(s)}})}}export class DPDTOnOn extends DPDTSwitch{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-blue.svg"}_getActuatorImageURLForState(){return 0===this.actuatorState?"/img/bat-small-left.svg":"/img/bat-small-right.svg"}_flipActuatorAndSetState(){this._setActuatorState(0===this.actuatorState?1:0)}_updatePinConnections(){0===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin1),this.pin5.connectToOtherPin(this.pin4)):(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin6))}}class DPDT3Position extends DPDTSwitch{constructor(t={}){super(t),this._prevActuatorState=-1===this.actuatorState||1===this.actuatorState?0:-1}_getValidActuatorStates(){return[-1,0,1]}_getActuatorImageURLForState(){return-1===this.actuatorState?"/img/bat-small-left.svg":0===this.actuatorState?"/img/bat-small-center.svg":1===this.actuatorState?"/img/bat-small-right.svg":void 0}_flipActuatorAndSetState(){let t;-1===this.actuatorState?t=0:0===this.actuatorState?t=-1===this._prevActuatorState?1:-1:1===this.actuatorState&&(t=0),this._prevActuatorState=this.actuatorState,this._setActuatorState(t)}}export class DPDTOnOffOn extends DPDT3Position{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-purple.svg"}_updatePinConnections(){-1===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin6)):0===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin()):1===this.actuatorState&&(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin1),this.pin5.connectToOtherPin(this.pin4))}}export class DPDTOnOnOn extends DPDT3Position{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-red.svg"}_updatePinConnections(){-1===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin6)):0===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin4)):1===this.actuatorState&&(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin1),this.pin5.connectToOtherPin(this.pin4))}}

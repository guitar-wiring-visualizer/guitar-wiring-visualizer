/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState,ToolMode,WireColors}from"./diagram.js";import{componentClassMap,Wire,Pin,ThreeWayToggle,Potentiometer}from"./components.js";import{Visualizer,VISUALIZER_WIRE_LINE_NAME,VISUALIZER_SIGNAL_PATH_NAME}from"./visualizer.js";import Geometry from"./geometry.js";import{EventDispatcher}from"./events.js";class App{constructor(e){this.window=e,this.document=e.document,this.wireColors=Object.values(WireColors).map(e=>e),this.serializedDiagramStateParam="d",this.debugModeParam="debug",this.document.addEventListener("DOMContentLoaded",async()=>{await this.setupApp(),this.document.getElementById("loader").hidden=!0})}async setupApp(){this.eventDispatcher=new EventDispatcher,this.initDomElements(),this.initDiagramState(),this.initComponentLibrary(),this.initDiagramLayer(),this.visualizer=new Visualizer(this.diagramLayer),this.enableDragDropFromLibrary(),this.addTransformer(),this.enableSelectComponent(),this.enableKeyboardCommands(),this.enableClearDiagram(),this.enableHideShowPins(),this.enableHideShowActuators(),this.enableHideShowInternals(),this.enableHideShowLabels(),this.enableToolbar(),this.enableDrawWire(),this.enableFlipSwitchButton(),this.enableRotatePotButton(),this.enablePropertiesButton(),this.enableVisualizerButton(),this.enableSaveButton(),this.enableCopyUrlButton(),await this.tryImportFromURL(),await this.tryLoadTestScript()}initDomElements(){const e=e=>{const t=this.document.getElementById(e);if(!t)throw new Error(`Element by id '${e}' null`);return t};this.elements={libraryItems:e("library-items"),flipButton:e("flip-button"),rotateButton:e("rotate-button"),propertiesButton:e("properties-button"),propertiesPanel:e("properties"),clearButton:e("clear-button"),visButton:e("vis-button"),checkShowConnectors:e("check-show-connectors"),cheeckShowActuators:e("check-show-actuators"),checkShowInternals:e("check-show-internals"),checkShowLabels:e("check-show-labels"),diagramContainer:e("diagram"),selectToolButton:e("select-tool-button"),wireToolButton:e("wire-tool-button"),inputComponentId:e("input-component-id"),inputComponentType:e("input-component-type"),inputComponentLabel:e("input-component-label"),saveButton:e("save-button"),copyUrlButton:e("copy-url-button")}}initDiagramState(){const e={},t=new URLSearchParams(this.window.location.search);t.has(this.debugModeParam)&&(e.debugMode="true"===t.get(this.debugModeParam).toLowerCase()),this.diagramState=new DiagramState(e)}initComponentLibrary(){this.document.querySelectorAll("[data-component-class]").forEach(e=>{const t=e.dataset.componentClass;e.src=componentClassMap[t].ImageURL})}initDiagramLayer(){const e=this.elements.diagramContainer;this.stage=new Konva.Stage({container:"diagram",width:e.clientWidth,height:1e3});const t=new Konva.Layer;this.stage.add(t),this.diagramLayer=t}enableDragDropFromLibrary(){let e="";this.elements.libraryItems.addEventListener("dragstart",t=>{e=t.target.dataset.componentClass});const t=this.stage.container();t.addEventListener("dragover",e=>{e.preventDefault()}),t.addEventListener("drop",t=>{t.preventDefault(),this.stage.setPointersPositions(t);const n=this.stage.getPointerPosition(),a={x:n.x-40,y:n.y-40},i=new componentClassMap[e];i.moveTo(a),i.draw(this.diagramLayer),this.focusStage()})}addTransformer(){this.transformer=new Konva.Transformer,this.diagramLayer.add(this.transformer)}enableSelectComponent(){this.stage.on("click tap",e=>{if(DiagramState.instance.toolMode===ToolMode.Wire)return;if(e.target===this.stage)return void this.clearSelection();const t=e.target;let n;if("Wire"===t.name())n=t;else if([VISUALIZER_WIRE_LINE_NAME,VISUALIZER_SIGNAL_PATH_NAME].includes(t.name())){const e=t.id().replace(VISUALIZER_WIRE_LINE_NAME+".","").replace(VISUALIZER_SIGNAL_PATH_NAME+".","");n=this.diagramLayer.findOne("#"+e)}else for(n=e.target.getParent();"Layer"!==n.getParent().getClassName();)n=n.getParent();this.transformer.nodes().indexOf(n)>=0||this.transformer.nodes([n]);const a=DiagramState.instance.getComponent(n.id());this.elements.flipButton.disabled=!0,this.elements.rotateButton.disabled=!0,a.can("flip")?this.elements.flipButton.disabled=!1:a.can("rotate")&&(this.elements.rotateButton.disabled=!1),this.elements.propertiesButton.disabled=!1})}enableKeyboardCommands(){this.stage.container().tabIndex=1,this.focusStage(),this.stage.container().addEventListener("keydown",e=>{this.handleGlobalKeyCode(e),this.handleSelectionKeyCode(e.code),this.handleToolbarKeyCode(e.code)})}enableClearDiagram(){this.elements.clearButton.onclick=()=>{if(confirm("Clear the diagram? Are you sure?  This cannot be undone!")){this.diagramLayer.getChildren().filter(e=>"Transformer"!==e.getClassName()).forEach(e=>{e.destroy()}),DiagramState.instance.removeAllComponents(),Visualizer.instance.isActive&&this.elements.visButton.click();const e=new URL(this.window.location);e.searchParams.delete(this.serializedDiagramStateParam),e.searchParams.delete(this.compressionTypeParam),this.window.history.replaceState({},"",e)}}}enableHideShowPins(){const e="."+Pin.pinCircleNodeName;this.elements.checkShowConnectors.addEventListener("change",t=>{DiagramState.instance.showConnectors=t.currentTarget.checked;var n=DiagramState.instance.showConnectors?1:0;this.diagramLayer.find(e).forEach(e=>{e.opacity(n)}),this.focusStage()})}enableHideShowActuators(){const e="."+ThreeWayToggle.actuatorNodeName;this.elements.cheeckShowActuators.addEventListener("change",t=>{DiagramState.instance.showActuators=t.currentTarget.checked;var n=DiagramState.instance.showActuators?1:0;this.diagramLayer.find(e).forEach(e=>{e.opacity(n)}),this.focusStage()})}enableHideShowInternals(){const e="."+ThreeWayToggle.pinConnectionNodeName+", ."+Potentiometer.pinConnectionNodeName;this.elements.checkShowInternals.addEventListener("change",t=>{DiagramState.instance.showInternals=t.currentTarget.checked;var n=DiagramState.instance.showInternals?1:0;this.diagramLayer.find(e).forEach(e=>{e.opacity(n)}),this.focusStage()})}enableHideShowLabels(){const e="."+Wire.labelNodeName;this.elements.checkShowLabels.addEventListener("change",t=>{DiagramState.instance.showLabels=t.currentTarget.checked;var n=DiagramState.instance.showLabels?1:0;this.diagramLayer.find(e).forEach(e=>{e.opacity(n)}),this.focusStage()})}enableToolbar(){this.lastWireColor=0;const e=this.elements.diagramContainer.style.cursor;this.elements.selectToolButton.addEventListener("click",t=>{DiagramState.instance.toolMode=ToolMode.Select,this.elements.diagramContainer.style.cursor=e,this.focusStage()}),this.elements.wireToolButton.addEventListener("click",e=>{DiagramState.instance.toolMode=ToolMode.Wire,this.elements.diagramContainer.style.cursor="crosshair",this.clearSelection(),this.focusStage()}),this.wireColors.forEach(e=>{this.document.getElementById("wire-color-"+e).addEventListener("click",t=>{if(DiagramState.instance.wireToolColor=e,0===this.transformer.nodes().length)return;const n=this.transformer.nodes()[0];this.changeColor(n)})})}enableDrawWire(){let e,t,n=!1;this.stage.on("mousedown touchstart",a=>{if(DiagramState.instance.toolMode===ToolMode.Select)return void(n=!1);n=!0;const i=this.stage.getPointerPosition(),o=new Konva.Rect({x:i.x-5,y:i.y-5,width:15,height:15,strokeWidth:1,stroke:DiagramState.instance.wireToolColor});this.diagramLayer.add(o);const s=this.findPinsInRect(o);if(o.destroy(),0===s.length)return void(n=!1);t=s[0];const r=t.getAbsolutePosition();e=new Konva.Line({stroke:DiagramState.instance.wireToolColor,strokeWidth:Wire.strokeWidth,globalCompositeOperation:"source-over",lineCap:"round",lineJoin:"round",points:[r.x,r.y]}),this.diagramLayer.add(e),this.stage.on("mousemove touchmove",t=>{if(DiagramState.instance.toolMode===ToolMode.Select)return void(n=!1);if(!n)return;t.evt.preventDefault();const a=this.stage.getPointerPosition(),i=e.points().concat([a.x,a.y]);e.points(i)})}),this.stage.on("mouseup touchend",a=>{if(this.stage.off("mousemove touchmove"),!n)return;n=!1;let i=e.points();const o=new Konva.Rect({x:i.at(-2)-5,y:i.at(-1)-5,width:15,height:15,strokeWidth:1,stroke:DiagramState.instance.wireToolColor});this.diagramLayer.add(o);const s=this.findPinsInRect(o);if(o.destroy(),0===s.length)return n=!1,void e.destroy();const r=s[0],l=r.getAbsolutePosition(),c=e.points().concat([l.x,l.y]);e.points(c),i=e.points(),e.destroy();const h=[i.at(0),i.at(1)],d=[i.at(-2),i.at(-1)];let m=[i.at(i.length/2-1),i.at(i.length/2)];(h[0]>h[1]&&m[0]<m[1]||h[0]<h[1]&&m[0]>m[1])&&(m=[m[1],m[0]]);new Wire({startPoint:h,midPoint:m,endPoint:d,startPinId:parseInt(t.id(),10),endPinId:parseInt(r.id(),10),color:DiagramState.instance.wireToolColor}).draw(this.diagramLayer),this.enterSelectMode()})}enableFlipSwitchButton(){this.elements.flipButton.addEventListener("click",e=>{if(e.preventDefault(),0===this.transformer.nodes().length)return;const t=this.transformer.nodes().at(0);this.flipSelectedSwitch(t),this.focusStage()})}enableRotatePotButton(){this.elements.rotateButton.addEventListener("click",e=>{if(e.preventDefault(),0===this.transformer.nodes().length)return;const t=this.transformer.nodes().at(0);this.rotateSelectedPot(t),this.focusStage()})}enablePropertiesButton(){const e=this.elements.propertiesPanel,t=new bootstrap.Offcanvas("#properties");this.elements.propertiesButton.addEventListener("click",e=>{const n=this.getSelectedComponent();n&&(this.elements.inputComponentId.value=n.id.toString(),this.elements.inputComponentType.value=n.constructor.name,this.elements.inputComponentLabel.value=n.label,t.show())}),e.addEventListener("hidden.bs.offcanvas",async()=>{const e=this.getSelectedComponent();e&&e.updateLabel(this.elements.inputComponentLabel.value.trim(),this.diagramLayer),this.focusStage()})}enableVisualizerButton(){const e=this.elements.visButton,t=e.textContent;e.addEventListener("click",n=>{Visualizer.instance.isActive?(e.textContent=t,DiagramState.instance.stop(),Visualizer.instance.stop()):(e.textContent="Stop Visualizer",DiagramState.instance.start(),Visualizer.instance.start()),this.focusStage()})}enableSaveButton(){this.elements.saveButton.addEventListener("click",async e=>{const t=this.elements.saveButton.textContent;this.elements.saveButton.textContent="Saving...",this.elements.saveButton.disabled=!0,await this.saveStateToURL(),this.elements.saveButton.textContent=t,this.elements.saveButton.disabled=!1})}async saveStateToURL(){const e=await DiagramState.instance.serializeState();if(""===e)return"";e.length>2e3&&this.window.alert("Saved successfully, but the link generated is long and may not work in all browsers.");const t=new URL(this.window.location);t.searchParams.set(this.serializedDiagramStateParam,e),this.window.history.replaceState({},"",t)}enableCopyUrlButton(){this.elements.copyUrlButton.addEventListener("click",async e=>{await this.window.navigator.clipboard.writeText(this.window.location)})}async tryImportFromURL(){const e=new URLSearchParams(this.window.location.search);if(e.has(this.serializedDiagramStateParam)){const t=e.get(this.serializedDiagramStateParam);await DiagramState.instance.loadState(t),DiagramState.instance.drawAll(this.diagramLayer)}return Promise.resolve()}async tryLoadTestScript(){const e=new URLSearchParams(this.window.location.search);if(e.has("script")){const{default:t}=await import("./testScripts.js"),n=e.get("script");if(!(n in t))throw new Error(`${n} is not a known test script`);t[n](this.diagramLayer)}return Promise.resolve()}getSelectedComponent(){if(0===this.transformer.nodes().length)return null;const e=this.transformer.nodes().at(0);return DiagramState.instance.getComponent(e.id())}openPropertiesPanel(){this.elements.propertiesButton.click()}enterSelectMode(){this.elements.selectToolButton.click()}enterWireMode(){this.elements.wireToolButton.click()}findPinsInRect(e){return this.diagramLayer.find(".Pin").filter(t=>{const n=t.getClientRect(),a=new Konva.Rect({x:n.x,y:n.y,width:n.width,height:n.height});return Geometry.rectanglesOverlap(e,a)})}handleGlobalKeyCode(e){e.ctrlKey&&"Enter"===e.key&&(this.elements.visButton.click(),e.preventDefault())}handleSelectionKeyCode(e){if(0===this.transformer.nodes().length)return;const t=this.transformer.nodes().at(0);"Delete"===e||"Backspace"===e?this.deleteSelectedComponent(t):"KeyF"===e?this.flipSelectedSwitch(t):"KeyR"===e?this.rotateSelectedPot(t):"KeyP"===e?this.openPropertiesPanel():"Escape"===e?this.clearSelection():"KeyC"===e&&(this.cycleWireColors(),this.changeColor(t))}handleToolbarKeyCode(e){this.transformer.nodes().length>0||("KeyW"===e?this.enterWireMode():"KeyS"===e?this.enterSelectMode():"KeyC"===e&&this.cycleWireColors())}cycleWireColors(){this.lastWireColor++,this.lastWireColor>this.wireColors.length-1&&(this.lastWireColor=0);const e=this.wireColors.at(this.lastWireColor);this.document.getElementById("wire-color-"+e).click()}changeColor(e){const t=DiagramState.instance.getComponent(e.id());t.changeColor&&t.changeColor(e,DiagramState.instance.wireToolColor)}clearSelection(){this.elements.flipButton.disabled=!0,this.elements.rotateButton.disabled=!0,this.elements.propertiesButton.disabled=!0,this.transformer.nodes([])}flipSelectedSwitch(e){const t=DiagramState.instance.getComponent(e.id());t.can("flip")&&t.flip(e)}rotateSelectedPot(e){const t=DiagramState.instance.getComponent(e.id());t.can("rotate")&&t.rotate(e)}deleteSelectedComponent(e){if(confirm("Delete selected component?")){const t=DiagramState.instance.getComponent(e.id()),n=this.transformer.getLayer();t.removeFromDiagram(n),this.clearSelection()}}focusStage(){this.stage.container().focus({preventScroll:!0})}}window.GuitarWiringVisualizer=new App(window);

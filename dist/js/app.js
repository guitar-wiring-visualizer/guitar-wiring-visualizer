/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState,TOOL_MODE_SELECT,TOOL_MODE_WIRE,WIRE_COLOR_BLACK,WIRE_COLOR_GREEN,WIRE_COLOR_YELLOW,WIRE_COLOR_RED,WIRE_COLOR_BLUE}from"./diagram.js";import{componentClassMap,Wire}from"./components.js";import{Visualizer,VISUALIZER_WIRE_LINE_NAME,VISUALIZER_SIGNAL_PATH_NAME}from"./visualizer.js";import Geometry from"./geometry.js";const wireColors=[WIRE_COLOR_BLACK,WIRE_COLOR_RED,WIRE_COLOR_YELLOW,WIRE_COLOR_GREEN,WIRE_COLOR_BLUE],SERIALIZED_DIAGRAM_STATE_PARAM="d",DEBUG_MODE_PARAM="debug",setupApp=async()=>{initializeDiagramState(),initializeComponentLibrary();const e=createDiagramLayer();window.GWVVisualizer=new Visualizer(e),enableDragDropFromLibrary(e);const t=addTransformer(e);enableSelectComponent(t),enableKeyboardCommands(t),enableClearDiagram(e),enableConnectorVisibilityToggle(e),enableToolbar(t),enableDrawWire(e),enableFlipSwitchButton(t),enableVisualizerButton(),enableSave(),await enableImportFromURL(e),await enableTestScript(e)};function initializeDiagramState(){const e={},t=new URLSearchParams(window.location.search);t.has("debug")&&(e.debugMode="true"===t.get("debug").toLowerCase()),window.GWVDiagramState=new DiagramState(e)}function enableSave(){document.getElementById("save-url").addEventListener("click",async e=>{const t=await saveStateToURL();t&&document.getElementById("check-copy-to-clipboard").checked&&await copyToClipboard(t)})}async function saveStateToURL(){const e=await DiagramState.instance.serializeState();if(""===e)return"";e.length>2e3&&alert("Uh Oh! This diagram may be too large to be saved. The link generated may not work in all browsers. Consider removing some components. The practical limit is around 40 items, including wires. Please submit an issue if this limits your ability to use the app.  You might want to take a screenshot of the diagram.");const t=new URL(window.location);return t.searchParams.set("d",e),window.history.replaceState({},"",t),t}async function copyToClipboard(e){await navigator.clipboard.writeText(e)}async function enableImportFromURL(e){const t=new URLSearchParams(window.location.search);if(t.has("d")){const n=t.get("d");await DiagramState.instance.loadState(n),DiagramState.instance.drawAll(e)}}async function enableTestScript(e){const t=new URLSearchParams(window.location.search);if(t.has("script")){const{default:n}=await import("./testScripts.js"),o=t.get("script");if(!(o in n))throw new Error(`${o} is not a known test script`);n[o](e)}}function enableVisualizerButton(){const e=document.getElementById("vis-button"),t=e.textContent;e.addEventListener("click",n=>{Visualizer.instance.isActive?(e.textContent=t,DiagramState.instance.stop(),Visualizer.instance.stop()):(e.textContent="Stop Visualizer",DiagramState.instance.start(),Visualizer.instance.start())})}function enableFlipSwitchButton(e){document.getElementById("flip-button").addEventListener("click",t=>{if(0===e.nodes().length)return;flipSelectedComponent(e.nodes()[0])})}function initializeComponentLibrary(){document.querySelectorAll("[data-component-class]").forEach(e=>{const t=e.dataset.componentClass;e.src=componentClassMap[t].ImageURL})}function enableToolbar(e){const t=document.getElementById("diagram").style.cursor,n=document.getElementById("select-tool"),o=document.getElementById("wire-tool");n.addEventListener("click",e=>{DiagramState.instance.toolMode=TOOL_MODE_SELECT,document.getElementById("diagram").style.cursor=t}),o.addEventListener("click",t=>{DiagramState.instance.toolMode=TOOL_MODE_WIRE,document.getElementById("diagram").style.cursor="crosshair",clearSelection(e)}),wireColors.forEach(t=>{document.getElementById("wire-color-"+t).addEventListener("click",n=>{if(DiagramState.instance.wireToolColor=t,0===e.nodes().length)return;changeColor(e.nodes()[0])})})}function enterSelectMode(){document.getElementById("select-tool").click()}function enterWireMode(){document.getElementById("wire-tool").click()}function enableDrawWire(e){let t,n=!1;const o=e.getStage();let a;o.on("mousedown touchstart",i=>{if(DiagramState.instance.toolMode===TOOL_MODE_SELECT)return void(n=!1);n=!0;const r=o.getPointerPosition(),c=new Konva.Rect({x:r.x-5,y:r.y-5,width:15,height:15,strokeWidth:1,stroke:DiagramState.instance.wireToolColor});e.add(c);const s=findPinsInRect(e,c);if(c.destroy(),0===s.length)return void(n=!1);a=s[0];const l=a.getAbsolutePosition();t=new Konva.Line({stroke:DiagramState.instance.wireToolColor,strokeWidth:5,globalCompositeOperation:"source-over",lineCap:"round",lineJoin:"round",points:[l.x,l.y]}),e.add(t),o.on("mousemove touchmove",function(e){if(DiagramState.instance.toolMode===TOOL_MODE_SELECT)return void(n=!1);if(!n)return;e.evt.preventDefault();const a=o.getPointerPosition(),i=t.points().concat([a.x,a.y]);t.points(i)})}),o.on("mouseup touchend",function(i){if(o.off("mousemove touchmove"),!n)return;n=!1;let r=t.points();const c=new Konva.Rect({x:r.at(-2)-5,y:r.at(-1)-5,width:15,height:15,strokeWidth:1,stroke:DiagramState.instance.wireToolColor});e.add(c);const s=findPinsInRect(e,c);if(c.destroy(),0===s.length)return n=!1,void t.destroy();const l=s[0],d=l.getAbsolutePosition(),m=t.points().concat([d.x,d.y]);t.points(m),r=t.points(),t.destroy();const u=[r.at(0),r.at(1)],g=[r.at(-2),r.at(-1)];let E=[r.at(r.length/2-1),r.at(r.length/2)];(u[0]>u[1]&&E[0]<E[1]||u[0]<u[1]&&E[0]>E[1])&&(E=[E[1],E[0]]);new Wire({startPoint:u,midPoint:E,endPoint:g,startPinId:parseInt(a.id(),10),endPinId:parseInt(l.id(),10),color:DiagramState.instance.wireToolColor}).draw(e),enterSelectMode()})}function findPinsInRect(e,t){return e.find(".Pin").filter(e=>{const n=e.getClientRect(),o=new Konva.Rect({x:n.x,y:n.y,width:n.width,height:n.height});return Geometry.rectanglesOverlap(t,o)})}function createDiagramLayer(){const e="diagram",t=document.getElementById(e),n=new Konva.Stage({container:e,width:t.clientWidth,height:1e3}),o=new Konva.Layer;return n.add(o),o}function enableDragDropFromLibrary(e){let t="";document.getElementById("library-items").addEventListener("dragstart",function(e){t=e.target.dataset.componentClass});const n=e.getStage(),o=n.container();o.addEventListener("dragover",function(e){e.preventDefault()}),o.addEventListener("drop",function(o){o.preventDefault(),n.setPointersPositions(o);const a=n.getPointerPosition(),i={x:a.x-40,y:a.y-40},r=new componentClassMap[t];r.moveTo(i),r.draw(e)})}function addTransformer(e){const t=new Konva.Transformer;return e.add(t),t}function enableSelectComponent(e){const t=e.getLayer(),n=t.getStage();n.on("click tap",function(o){if(DiagramState.instance.toolMode===TOOL_MODE_WIRE)return;if(o.target===n)return void clearSelection(e);const a=o.target;let i;if("Wire"===a.name())i=a;else if([VISUALIZER_WIRE_LINE_NAME,VISUALIZER_SIGNAL_PATH_NAME].includes(a.name())){const e=a.id().replace(VISUALIZER_WIRE_LINE_NAME+".","").replace(VISUALIZER_SIGNAL_PATH_NAME+".","");i=t.findOne("#"+e)}else for(i=o.target.getParent();"Layer"!==i.getParent().getClassName();)i=i.getParent();e.nodes().indexOf(i)>=0||e.nodes([i]),document.getElementById("flip-button").disabled=!1})}function enableKeyboardCommands(e){const t=e.getStage();t.container().tabIndex=1,t.container().addEventListener("keydown",t=>{handleGlobalKeyCode(t),handleSelectionKeyCode(e,t.code),handleToolbarKeyCode(e,t.code)})}function handleGlobalKeyCode(e){e.ctrlKey&&"Enter"===e.key&&(document.getElementById("vis-button").click(),e.preventDefault())}function handleSelectionKeyCode(e,t){if(0===e.nodes().length)return;const n=e.nodes()[0];"Delete"===t||"Backspace"===t?deleteSelectedComponent(n,e):"KeyF"===t?flipSelectedComponent(n):"Escape"===t?clearSelection(e):"KeyC"===t&&(cycleWireColors(),changeColor(n))}function handleToolbarKeyCode(e,t){e.nodes().length>0||("KeyW"===t?enterWireMode():"KeyS"===t?enterSelectMode():"KeyC"===t&&cycleWireColors())}let lastWireColor=0;function cycleWireColors(){lastWireColor++,lastWireColor>wireColors.length-1&&(lastWireColor=0);const e=wireColors.at(lastWireColor);document.getElementById("wire-color-"+e).click()}function changeColor(e){const t=DiagramState.instance.getComponent(e.id());t.changeColor&&t.changeColor(e,DiagramState.instance.wireToolColor)}function clearSelection(e){document.getElementById("flip-button").disabled=!0,e.nodes([])}function flipSelectedComponent(e){const t=DiagramState.instance.getComponent(e.id());"function"==typeof t.flip?t.flip(e):"function"==typeof t.rotate&&t.rotate(e)}function deleteSelectedComponent(e,t){if(confirm("Delete selected component?")){const n=DiagramState.instance.getComponent(e.id()),o=t.getLayer();n.removeFromDiagram(o),clearSelection(t)}}function enableClearDiagram(e){document.getElementById("clear-button").onclick=function(){if(confirm("Clear the diagram? Are you sure?  This cannot be undone!")){e.getChildren().filter(e=>"Transformer"!==e.getClassName()).forEach(e=>{e.destroy(),DiagramState.instance.removeAllComponents()}),Visualizer.instance.isActive&&document.getElementById("vis-button").click();const t=new URL(window.location);t.searchParams.delete("d"),window.history.replaceState({},"",t)}}}function enableConnectorVisibilityToggle(e){document.getElementById("check-show-connectors").addEventListener("change",t=>{DiagramState.instance.showConnectors=t.currentTarget.checked;var n=DiagramState.instance.showConnectors?1:0;e.find("Circle").forEach(e=>{e.opacity(n)})})}document.addEventListener("DOMContentLoaded",function(){document.getElementById("loader").hidden=!0,setupApp()});

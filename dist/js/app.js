import {DiagramState as a,TOOL_MODE_SELECT as b,TOOL_MODE_WIRE as c,WIRE_COLOR_BLACK as d,WIRE_COLOR_GREEN as A,WIRE_COLOR_YELLOW as f,WIRE_COLOR_RED as g,WIRE_COLOR_BLUE as h,} from'./diagram.js';import {DPDTOnOn as i,DPDTOnOffOn as j,DPDTOnOnOn as k,Potentiometer as l,Wire as m,Humbucker as n,StratPickup as o,MonoJack as p,} from'./components.js';import {Visualizer as q} from'./visualizer.js';let r={Potentiometer:l,DPDTOnOn:i,DPDTOnOffOn:j,DPDTOnOnOn:k,Humbucker:n,StratPickup:o,MonoJack:p},s=[d,g,f,A,h],t=()=>{window.GWVDiagramState=new a;w();let C=aD();window.GWVVisualizer=new q(C);aE(C);let _b=aF(C);aG(_b);aH(_b);aR(C);aS(C);_(_b);aA(C);v(_b);u()};function u(){let _a=document.getElementById('vis-button'),D=_a.textContent;_a.addEventListener('click',()=>{q.instance.isActive?(_a.textContent=D,q.instance.stop()):(_a.textContent='Stop Visualizer',q.instance.start())})}function v(_A){let _B=document.getElementById('flip-button');_B.addEventListener('click',()=>{if(_A.nodes().length===0)return;aP(_A.nodes()[0])})}function w(){for(const E of document.querySelectorAll('[data-component-class]')){let aT=E.dataset.componentClass;E.src=r[aT].ImageURL}}function _(aU){let aV=document.getElementById('diagram').style.cursor,_c=document.getElementById('select-tool'),_d=document.getElementById('wire-tool');_c.addEventListener('click',()=>{a.instance.toolMode=b;document.getElementById('diagram').style.cursor=aV});_d.addEventListener('click',()=>{a.instance.toolMode=c;document.getElementById('diagram').style.cursor='crosshair';aO(aU)});for(const aW of s){let aX=document.getElementById(`wire-color-${aW}`);aX.addEventListener('click',()=>{a.instance.wireToolColor=aW;if(aU.nodes().length===0)return;aN(aU.nodes()[0])})}}function B(){document.getElementById('select-tool').click()}function z(){document.getElementById('wire-tool').click()}function aA(aY){let aZ,_C=!1;let _D=aY.getStage();let _e;_D.on('mousedown touchstart',()=>{if(a.instance.toolMode===b){_C=!1;return}_C=!0;let bA=_D.getPointerPosition(),bD=_e.getAbsolutePosition();let bB=new Konva.Rect({x:bA.x-5,y:bA.y-5,width:15,height:15,strokeWidth:1,stroke:a.instance.wireToolColor});aY.add(bB);let bC=aB(aY,bB);bB.destroy();if(bC.length===0){_C=!1;return}_e=bC[0];aZ=new Konva.Line({stroke:a.instance.wireToolColor,strokeWidth:5,globalCompositeOperation:'source-over',lineCap:'round',lineJoin:'round',points:[bD.x,bD.y]});aY.add(aZ)});_D.on('mousemove touchmove',function(e){if(a.instance.toolMode===b){_C=!1;return}if(!_C)return;e.evt.preventDefault();let bE=_D.getPointerPosition();aZ.points(aZ.points().concat([bE.x,bE.y]))});_D.on('mouseup touchend',function(){if(!_C)return;_C=!1;let bF=aZ.points(),bI=bH[0],_E=bI.getAbsolutePosition(),G=[bF.at(-2),bF.at(-1)],H=[bF.at((bF.length/2)-1),bF.at((bF.length/2))];let bG=new Konva.Rect({x:bF.at(-2)-5,y:bF.at(-1)-5,width:15,height:15,strokeWidth:1,stroke:a.instance.wireToolColor});aY.add(bG);let bH=aB(aY,bG);bG.destroy();if(bH.length===0){_C=!1;aZ.destroy();return}aZ.points(aZ.points().concat([_E.x,_E.y]));let F=[bF.at(0),bF.at(1)];((F[0]>F[1]&&H[0]<H[1])||(F[0]<F[1]&&H[0]>H[1]))&&(H=[H[1],H[0]]);let I=new m({_startPoint:F,_midPoint:H,_endPoint:G,_startPinId:parseInt(_e.id(),10),_endPinId:parseInt(bI.id(),10),_color:a.instance.wireToolColor});setTimeout(()=>{I.createOnLayer(aY);aZ.destroy()},200);B()})}function aB(bJ,bK){let bL=bJ.find('.Pin').filter(bM=>{let bN=bM.getClientRect();return aC(bK,new Konva.Rect({x:bN.x,y:bN.y,width:bN.width,height:bN.height}))});return bL}function aC(bO,bP){return bO.x()<bP.x()+bP.width()&&bO.x()+bO.width()>bP.x()&&bO.y()<bP.y()+bP.height()&&bO.y()+bO.height()>bP.y()}function aD(){let bQ='diagram',bR=document.getElementById(bQ);let bS=new Konva.Stage({container:bQ,width:bR.clientWidth,height:1000});let bT=new Konva.Layer;bS.add(bT);return bT}function aE(bU){let bV='';document.getElementById('library-items').addEventListener('dragstart',function(e){bV=e.target.dataset.componentClass});let bW=bU.getStage();let bX=bW.container();bX.addEventListener('dragover',function(e){e.preventDefault()});bX.addEventListener('drop',function(e){e.preventDefault();bW.setPointersPositions(e);let bY=bW.getPointerPosition(),bZ=40,x=bY.x-bZ,y=bY.y-bZ,_f={};let _g=new r[bV](_f);_g.createOnLayer(bU,{x,y})})}function aF(cA){let cB=new Konva.Transformer;cA.add(cB);return cB}function aG(cC){let cD=cC.getLayer(),cE=cD.getStage();cE.on('click tap',function(e){if(a.instance.toolMode===c)return;if(e.target===cE){aO(cC);return}let cF=e.target,cG;if(cF.getClassName()==='Line')cG=cF;else{cG=e.target.getParent();while(cG.getParent().getClassName()!=='Layer')cG=cG.getParent()}let cH=cC.nodes().indexOf(cG)>=0;!cH&&cC.nodes([cG]);document.getElementById('flip-button').disabled=!1})}function aH(cI){let cJ=cI.getStage();cJ.container().tabIndex=1;cJ.container().addEventListener('keydown',e=>{aI(e);aJ(cI,e.code);aK(cI,e.code)})}function aI(e){(e.ctrlKey&&e.key==='Enter')&&(document.getElementById('vis-button').click(),e.preventDefault())}function aJ(cK,cL){if(cK.nodes().length===0)return;let cM=cK.nodes()[0];if(cL==='Delete'||cL==='Backspace')aQ(cM,cK);else if(cL==='KeyF')aP(cM);else if(cL==='Escape')aO(cK);else cL==='KeyC'&&(aM(),aN(cM))}function aK(cN,cO){if(cN.nodes().length>0)return;if(cO==='KeyW')z();else if(cO==='KeyS')B();else cO==='KeyC'&&aM()}let aL=0;function aM(){aL++;aL>s.length-1&&(aL=0);let cP=s.at(aL),cQ=document.getElementById(`wire-color-${cP}`);cQ.click()}function aN(cR){let cS=a.instance.getComponent(cR.id());cS.changeColor&&cS.changeColor(cR,a.instance.wireToolColor)}function aO(cT){document.getElementById('flip-button').disabled=!0;cT.nodes([])}function aP(cU){let cV=a.instance.getComponent(cU.id());if(!cV.flip)return;cV.flip(cU)}function aQ(cW,cX){confirm('Delete selected component?')&&(cW.destroy(),a.instance.removeComponentById(cW.id()),aO(cX))}function aR(cY){document.getElementById('clear-button').onclick=()=>{confirm('Clear the diagram? Are you sure?  This cannot be undone!')&&cY.getChildren().filter(cZ=>cZ.getClassName()!=='Transformer').forEach(dA=>{dA.destroy();a.instance.notifyNodeChanged(dA);a.instance.removeComponentById(dA.id())})}}function aS(dB){let dC=document.getElementById('check-show-connectors');dC.addEventListener('change',dD=>{a.instance.showConnectors=dD.currentTarget.checked;var dE=a.instance.showConnectors?1:0;for(const dF of dB.find('Circle'))dF.opacity(dE)})}document.addEventListener('DOMContentLoaded',function(){document.getElementById('loader').hidden=!0;t()});

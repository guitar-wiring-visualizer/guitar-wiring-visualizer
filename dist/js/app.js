/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState,TOOL_MODE_SELECT,TOOL_MODE_WIRE,WIRE_COLOR_BLACK,WIRE_COLOR_GREEN,WIRE_COLOR_YELLOW,WIRE_COLOR_RED,WIRE_COLOR_BLUE}from"./diagram.js";import{componentClassMap,Wire}from"./components.js";import{Visualizer}from"./visualizer.js";const wireColors=[WIRE_COLOR_BLACK,WIRE_COLOR_RED,WIRE_COLOR_YELLOW,WIRE_COLOR_GREEN,WIRE_COLOR_BLUE],SERIALIZED_DIAGRAM_STATE_PARAM="d",setupApp=async()=>{window.GWVDiagramState=new DiagramState,initializeComponentLibrary();const e=createDiagramLayer();window.GWVVisualizer=new Visualizer(e),enableDragDropFromLibrary(e);const t=addTransformer(e);enableSelectComponent(t),enableKeyboardCommands(t),enableClearDiagram(e),enableConnectorVisibilityToggle(e),enableToolbar(t),enableDrawWire(e),enableFlipSwitchButton(t),enableVisualizerButton(),enableSaveToURL(),enableSaveAndCopyURL(),enableImportFromURL(e),await enableTestScript(e)};function saveStateToURL(){const e=DiagramState.instance.serializeState();if(""===e)return"";const t=new URL(window.location);return t.searchParams.set("d",e),window.history.replaceState({},"",t),t}function enableSaveToURL(){document.getElementById("save-url").addEventListener("click",e=>{saveStateToURL()&&alert("Diagram was saved to the URL.")})}function enableSaveAndCopyURL(){document.getElementById("save-copy-url").addEventListener("click",async e=>{const t=saveStateToURL();t&&(await copyToClipboard(t),alert("Diagram was saved and link copied to your clipboard."))})}async function copyToClipboard(e){await navigator.clipboard.writeText(e)}function enableImportFromURL(e){const t=new URLSearchParams(window.location.search);if(t.has("d")){const n=t.get("d");DiagramState.instance.loadState(n),DiagramState.instance.drawAll(e)}}async function enableTestScript(e){const t=new URLSearchParams(window.location.search);if(t.has("script")){const{default:n}=await import("./testScripts.js"),o=t.get("script");if(!(o in n))throw new Error(`${o} is not a known test script`);n[o](e)}}function findAllPickups(){return DiagramState.instance.findComponents(e=>"function"==typeof e.pickUp)}function simulateGuitar(){findAllPickups().forEach(e=>e.pickUp())}function stopSimulatingGuitar(){findAllPickups().forEach(e=>e.stopPickingUp())}function enableVisualizerButton(){const e=document.getElementById("vis-button"),t=e.textContent;e.addEventListener("click",n=>{Visualizer.instance.isActive?(e.textContent=t,stopSimulatingGuitar(),Visualizer.instance.stop()):(e.textContent="Stop Visualizer",simulateGuitar(),Visualizer.instance.start())})}function enableFlipSwitchButton(e){document.getElementById("flip-button").addEventListener("click",t=>{if(0===e.nodes().length)return;flipSelectedSwitch(e.nodes()[0])})}function initializeComponentLibrary(){document.querySelectorAll("[data-component-class]").forEach(e=>{const t=e.dataset.componentClass;e.src=componentClassMap[t].ImageURL})}function enableToolbar(e){const t=document.getElementById("diagram").style.cursor,n=document.getElementById("select-tool"),o=document.getElementById("wire-tool");n.addEventListener("click",e=>{DiagramState.instance.toolMode=TOOL_MODE_SELECT,document.getElementById("diagram").style.cursor=t}),o.addEventListener("click",t=>{DiagramState.instance.toolMode=TOOL_MODE_WIRE,document.getElementById("diagram").style.cursor="crosshair",clearSelection(e)}),wireColors.forEach(t=>{document.getElementById("wire-color-"+t).addEventListener("click",n=>{if(DiagramState.instance.wireToolColor=t,0===e.nodes().length)return;changeColor(e.nodes()[0])})})}function enterSelectMode(){document.getElementById("select-tool").click()}function enterWireMode(){document.getElementById("wire-tool").click()}function enableDrawWire(e){let t,n=!1;const o=e.getStage();let a;o.on("mousedown touchstart",i=>{if(DiagramState.instance.toolMode===TOOL_MODE_SELECT)return void(n=!1);n=!0;const r=o.getPointerPosition(),c=new Konva.Rect({x:r.x-5,y:r.y-5,width:15,height:15,strokeWidth:1,stroke:DiagramState.instance.wireToolColor});e.add(c);const l=findPinsInRect(e,c);if(c.destroy(),0===l.length)return void(n=!1);a=l[0];const s=a.getAbsolutePosition();t=new Konva.Line({stroke:DiagramState.instance.wireToolColor,strokeWidth:5,globalCompositeOperation:"source-over",lineCap:"round",lineJoin:"round",points:[s.x,s.y]}),e.add(t)}),o.on("mousemove touchmove",function(e){if(DiagramState.instance.toolMode===TOOL_MODE_SELECT)return void(n=!1);if(!n)return;e.evt.preventDefault();const a=o.getPointerPosition(),i=t.points().concat([a.x,a.y]);t.points(i)}),o.on("mouseup touchend",function(){if(!n)return;n=!1;const o=t.points(),i=new Konva.Rect({x:o.at(-2)-5,y:o.at(-1)-5,width:15,height:15,strokeWidth:1,stroke:DiagramState.instance.wireToolColor});e.add(i);const r=findPinsInRect(e,i);if(i.destroy(),0===r.length)return n=!1,void t.destroy();const c=r[0],l=c.getAbsolutePosition(),s=t.points().concat([l.x,l.y]);t.points(s);const d=[o.at(0),o.at(1)],m=[o.at(-2),o.at(-1)];let u=[o.at(o.length/2-1),o.at(o.length/2)];(d[0]>d[1]&&u[0]<u[1]||d[0]<d[1]&&u[0]>u[1])&&(u=[u[1],u[0]]);const g=new Wire({startPoint:d,midPoint:u,endPoint:m,startPinId:parseInt(a.id(),10),endPinId:parseInt(c.id(),10),color:DiagramState.instance.wireToolColor});setTimeout(()=>{g.draw(e),t.destroy()},200),enterSelectMode()})}function findPinsInRect(e,t){return e.find(".Pin").filter(e=>{const n=e.getClientRect(),o=new Konva.Rect({x:n.x,y:n.y,width:n.width,height:n.height});return rectanglesOverlap(t,o)})}function rectanglesOverlap(e,t){return e.x()<t.x()+t.width()&&e.x()+e.width()>t.x()&&e.y()<t.y()+t.height()&&e.y()+e.height()>t.y()}function createDiagramLayer(){const e="diagram",t=document.getElementById(e),n=new Konva.Stage({container:e,width:t.clientWidth,height:1e3}),o=new Konva.Layer;return n.add(o),o}function enableDragDropFromLibrary(e){let t="";document.getElementById("library-items").addEventListener("dragstart",function(e){t=e.target.dataset.componentClass});const n=e.getStage(),o=n.container();o.addEventListener("dragover",function(e){e.preventDefault()}),o.addEventListener("drop",function(o){o.preventDefault(),n.setPointersPositions(o);const a=n.getPointerPosition(),i={x:a.x-40,y:a.y-40},r=new componentClassMap[t];r.moveTo(i),r.draw(e)})}function addTransformer(e){const t=new Konva.Transformer;return e.add(t),t}function enableSelectComponent(e){const t=e.getLayer().getStage();t.on("click tap",function(n){if(DiagramState.instance.toolMode===TOOL_MODE_WIRE)return;if(n.target===t)return void clearSelection(e);const o=n.target;let a;if("Line"===o.getClassName())a=o;else for(a=n.target.getParent();"Layer"!==a.getParent().getClassName();)a=a.getParent();e.nodes().indexOf(a)>=0||e.nodes([a]),document.getElementById("flip-button").disabled=!1})}function enableKeyboardCommands(e){const t=e.getStage();t.container().tabIndex=1,t.container().addEventListener("keydown",t=>{handleGlobalKeyCode(t),handleSelectionKeyCode(e,t.code),handleToolbarKeyCode(e,t.code)})}function handleGlobalKeyCode(e){e.ctrlKey&&"Enter"===e.key&&(document.getElementById("vis-button").click(),e.preventDefault())}function handleSelectionKeyCode(e,t){if(0===e.nodes().length)return;const n=e.nodes()[0];"Delete"===t||"Backspace"===t?deleteSelectedComponent(n,e):"KeyF"===t?flipSelectedSwitch(n):"Escape"===t?clearSelection(e):"KeyC"===t&&(cycleWireColors(),changeColor(n))}function handleToolbarKeyCode(e,t){e.nodes().length>0||("KeyW"===t?enterWireMode():"KeyS"===t?enterSelectMode():"KeyC"===t&&cycleWireColors())}let lastWireColor=0;function cycleWireColors(){lastWireColor++,lastWireColor>wireColors.length-1&&(lastWireColor=0);const e=wireColors.at(lastWireColor);document.getElementById("wire-color-"+e).click()}function changeColor(e){const t=DiagramState.instance.getComponent(e.id());t.changeColor&&t.changeColor(e,DiagramState.instance.wireToolColor)}function clearSelection(e){document.getElementById("flip-button").disabled=!0,e.nodes([])}function flipSelectedSwitch(e){const t=DiagramState.instance.getComponent(e.id());t.flip&&t.flip(e)}function deleteSelectedComponent(e,t){confirm("Delete selected component?")&&(e.destroy(),DiagramState.instance.removeComponentById(e.id()),clearSelection(t))}function enableClearDiagram(e){document.getElementById("clear-button").onclick=function(){if(confirm("Clear the diagram? Are you sure?  This cannot be undone!")){e.getChildren().filter(e=>"Transformer"!==e.getClassName()).forEach(e=>{e.destroy(),DiagramState.instance.notifyNodeChanged(e),DiagramState.instance.removeComponentById(e.id())});const t=new URL(window.location);t.searchParams.delete("d"),window.history.replaceState({},"",t)}}}function enableConnectorVisibilityToggle(e){document.getElementById("check-show-connectors").addEventListener("change",t=>{DiagramState.instance.showConnectors=t.currentTarget.checked;var n=DiagramState.instance.showConnectors?1:0;e.find("Circle").forEach(e=>{e.opacity(n)})})}document.addEventListener("DOMContentLoaded",function(){document.getElementById("loader").hidden=!0,setupApp()});

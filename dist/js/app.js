/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState,TOOL_MODE_SELECT,TOOL_MODE_WIRE,WIRE_COLOR_BLACK,WIRE_COLOR_GREEN,WIRE_COLOR_YELLOW,WIRE_COLOR_RED,WIRE_COLOR_BLUE}from"./diagram.js";import{componentClassMap,Wire}from"./components.js";import{Visualizer,VISUALIZER_WIRE_LINE_NAME,VISUALIZER_SIGNAL_PATH_NAME}from"./visualizer.js";import Geometry from"./geometry.js";class App{constructor(e){this.window=e,this.document=e.document,this.wireColors=[WIRE_COLOR_BLACK,WIRE_COLOR_RED,WIRE_COLOR_YELLOW,WIRE_COLOR_GREEN,WIRE_COLOR_BLUE],this.serializedDiagramStateParam="d",this.debugModeParam="debug",this.document.addEventListener("DOMContentLoaded",async()=>{this.document.getElementById("loader").hidden=!0,await this.setupApp()})}async setupApp(){this.initDomElements(),this.initDiagramState(),this.initComponentLibrary(),this.initDiagramLayer(),this.visualizer=new Visualizer(this.diagramLayer),this.enableDragDropFromLibrary(),this.addTransformer(),this.enableSelectComponent(),this.enableKeyboardCommands(),this.enableClearDiagram(),this.enableHideShowPins(),this.enableToolbar(),this.enableDrawWire(),this.enableFlipSwitchButton(),this.enableRotatePotButton(),this.enablePropertiesButton(),this.enableVisualizerButton(),this.enableSave(),await this.tryImportFromURL(),await this.tryLoadTestScript()}initDomElements(){const e=e=>{const t=this.document.getElementById(e);if(!t)throw new Error(`Element by id '${e}' null`);return t};this.elements={libraryItems:e("library-items"),flipButton:e("flip-button"),rotateButton:e("rotate-button"),propertiesButton:e("properties-button"),propertiesPanel:e("properties"),clearButton:e("clear-button"),visButton:e("vis-button"),checkShowConnectors:e("check-show-connectors"),diagramContainer:e("diagram"),selectToolButton:e("select-tool"),wireToolButton:e("wire-tool"),inputComponentId:e("input-component-id"),inputComponentType:e("input-component-type"),inputComponentLabel:e("input-component-label"),saveButton:e("save-url"),checkCopyClip:e("check-copy-to-clipboard")}}initDiagramState(){const e={},t=new URLSearchParams(this.window.location.search);t.has(this.debugModeParam)&&(e.debugMode="true"===t.get(this.debugModeParam).toLowerCase()),this.diagramState=new DiagramState(e)}initComponentLibrary(){this.document.querySelectorAll("[data-component-class]").forEach(e=>{const t=e.dataset.componentClass;e.src=componentClassMap[t].ImageURL})}initDiagramLayer(){const e=this.elements.diagramContainer;this.stage=new Konva.Stage({container:"diagram",width:e.clientWidth,height:1e3});const t=new Konva.Layer;this.stage.add(t),this.diagramLayer=t}enableDragDropFromLibrary(){let e="";this.elements.libraryItems.addEventListener("dragstart",t=>{e=t.target.dataset.componentClass});const t=this.stage.container();t.addEventListener("dragover",e=>{e.preventDefault()}),t.addEventListener("drop",t=>{t.preventDefault(),this.stage.setPointersPositions(t);const i=this.stage.getPointerPosition(),n={x:i.x-40,y:i.y-40},a=new componentClassMap[e];a.moveTo(n),a.draw(this.diagramLayer)})}addTransformer(){this.transformer=new Konva.Transformer,this.diagramLayer.add(this.transformer)}enableSelectComponent(){this.stage.on("click tap",e=>{if(DiagramState.instance.toolMode===TOOL_MODE_WIRE)return;if(e.target===this.stage)return void this.clearSelection();const t=e.target;let i;if("Wire"===t.name())i=t;else if([VISUALIZER_WIRE_LINE_NAME,VISUALIZER_SIGNAL_PATH_NAME].includes(t.name())){const e=t.id().replace(VISUALIZER_WIRE_LINE_NAME+".","").replace(VISUALIZER_SIGNAL_PATH_NAME+".","");i=this.diagramLayer.findOne("#"+e)}else for(i=e.target.getParent();"Layer"!==i.getParent().getClassName();)i=i.getParent();this.transformer.nodes().indexOf(i)>=0||this.transformer.nodes([i]);const n=DiagramState.instance.getComponent(i.id());this.elements.flipButton.disabled=!0,this.elements.rotateButton.disabled=!0,n.can("flip")?this.elements.flipButton.disabled=!1:n.can("rotate")&&(this.elements.rotateButton.disabled=!1),this.elements.propertiesButton.disabled=!1})}enableKeyboardCommands(){this.stage.container().tabIndex=1,this.stage.container().focus({preventScroll:!0}),this.stage.container().addEventListener("keydown",e=>{this.handleGlobalKeyCode(e),this.handleSelectionKeyCode(e.code),this.handleToolbarKeyCode(e.code)})}enableClearDiagram(){this.elements.clearButton.onclick=()=>{if(confirm("Clear the diagram? Are you sure?  This cannot be undone!")){this.diagramLayer.getChildren().filter(e=>"Transformer"!==e.getClassName()).forEach(e=>{e.destroy(),DiagramState.instance.removeAllComponents()}),Visualizer.instance.isActive&&this.elements.visButton.click();const e=new URL(this.window.location);e.searchParams.delete(this.serializedDiagramStateParam),this.window.history.replaceState({},"",e)}}}enableHideShowPins(){this.elements.checkShowConnectors.addEventListener("change",e=>{DiagramState.instance.showConnectors=e.currentTarget.checked;var t=DiagramState.instance.showConnectors?1:0;this.diagramLayer.find("Circle").forEach(e=>{e.opacity(t)})})}enableToolbar(){this.lastWireColor=0;const e=this.elements.diagramContainer.style.cursor,t=this.elements.selectToolButton,i=this.elements.wireToolButton;t.addEventListener("click",t=>{DiagramState.instance.toolMode=TOOL_MODE_SELECT,this.elements.diagramContainer.style.cursor=e}),i.addEventListener("click",e=>{DiagramState.instance.toolMode=TOOL_MODE_WIRE,this.elements.diagramContainer.style.cursor="crosshair",this.clearSelection()}),this.wireColors.forEach(e=>{this.document.getElementById("wire-color-"+e).addEventListener("click",t=>{if(DiagramState.instance.wireToolColor=e,0===this.transformer.nodes().length)return;const i=this.transformer.nodes()[0];changeColor(i)})})}enableDrawWire(){let e,t,i=!1;this.stage.on("mousedown touchstart",n=>{if(DiagramState.instance.toolMode===TOOL_MODE_SELECT)return void(i=!1);i=!0;const a=this.stage.getPointerPosition(),o=new Konva.Rect({x:a.x-5,y:a.y-5,width:15,height:15,strokeWidth:1,stroke:DiagramState.instance.wireToolColor});this.diagramLayer.add(o);const s=this.findPinsInRect(o);if(o.destroy(),0===s.length)return void(i=!1);t=s[0];const r=t.getAbsolutePosition();e=new Konva.Line({stroke:DiagramState.instance.wireToolColor,strokeWidth:2,globalCompositeOperation:"source-over",lineCap:"round",lineJoin:"round",points:[r.x,r.y]}),this.diagramLayer.add(e),this.stage.on("mousemove touchmove",t=>{if(DiagramState.instance.toolMode===TOOL_MODE_SELECT)return void(i=!1);if(!i)return;t.evt.preventDefault();const n=this.stage.getPointerPosition(),a=e.points().concat([n.x,n.y]);e.points(a)})}),this.stage.on("mouseup touchend",n=>{if(this.stage.off("mousemove touchmove"),!i)return;i=!1;let a=e.points();const o=new Konva.Rect({x:a.at(-2)-5,y:a.at(-1)-5,width:15,height:15,strokeWidth:1,stroke:DiagramState.instance.wireToolColor});this.diagramLayer.add(o);const s=this.findPinsInRect(o);if(o.destroy(),0===s.length)return i=!1,void e.destroy();const r=s[0],l=r.getAbsolutePosition(),c=e.points().concat([l.x,l.y]);e.points(c),a=e.points(),e.destroy();const d=[a.at(0),a.at(1)],h=[a.at(-2),a.at(-1)];let m=[a.at(a.length/2-1),a.at(a.length/2)];(d[0]>d[1]&&m[0]<m[1]||d[0]<d[1]&&m[0]>m[1])&&(m=[m[1],m[0]]);new Wire({startPoint:d,midPoint:m,endPoint:h,startPinId:parseInt(t.id(),10),endPinId:parseInt(r.id(),10),color:DiagramState.instance.wireToolColor}).draw(this.diagramLayer),this.enterSelectMode()})}enableFlipSwitchButton(){this.elements.flipButton.addEventListener("click",e=>{if(e.preventDefault(),0===this.transformer.nodes().length)return;const t=this.transformer.nodes().at(0);this.flipSelectedSwitch(t),this.stage.container().focus({preventScroll:!0})})}enableRotatePotButton(){this.elements.rotateButton.addEventListener("click",e=>{if(e.preventDefault(),0===this.transformer.nodes().length)return;const t=this.transformer.nodes().at(0);this.rotateSelectedPot(t),this.stage.container().focus({preventScroll:!0})})}enablePropertiesButton(){const e=this.elements.propertiesPanel,t=new bootstrap.Offcanvas("#properties");this.elements.propertiesButton.addEventListener("click",e=>{const i=this.getSelectedComponent();i&&(this.elements.inputComponentId.value=i.id.toString(),this.elements.inputComponentType.value=i.constructor.name,this.elements.inputComponentLabel.value=i.label,t.show())}),e.addEventListener("hidden.bs.offcanvas",async()=>{const e=this.getSelectedComponent();e&&e.updateLabel(this.elements.inputComponentLabel.value.trim(),this.diagramLayer),this.stage.container().focus({preventScroll:!0})})}enableVisualizerButton(){const e=this.elements.visButton,t=e.textContent;e.addEventListener("click",i=>{Visualizer.instance.isActive?(e.textContent=t,DiagramState.instance.stop(),Visualizer.instance.stop()):(e.textContent="Stop Visualizer",DiagramState.instance.start(),Visualizer.instance.start()),this.stage.container().focus({preventScroll:!0})})}enableSave(){this.elements.saveButton.addEventListener("click",async e=>{const t=await this.saveStateToURL();t&&this.elements.checkCopyClip.checked&&await this.copyToClipboard(t)})}async saveStateToURL(){const e=await DiagramState.instance.serializeState();if(""===e)return"";e.length>2e3&&this.window.alert("Uh Oh! This diagram may be too large to be saved. The link generated may not work in all browsers. Consider removing some components. The practical limit is around 40 items, including wires. Please submit an issue if this limits your ability to use the app.  You might want to take a screenshot of the diagram.");const t=new URL(this.window.location);return t.searchParams.set(this.serializedDiagramStateParam,e),this.window.history.replaceState({},"",t),t}async copyToClipboard(e){await this.window.navigator.clipboard.writeText(e)}async tryImportFromURL(){const e=new URLSearchParams(this.window.location.search);if(e.has(this.serializedDiagramStateParam)){const t=e.get(this.serializedDiagramStateParam);await DiagramState.instance.loadState(t),DiagramState.instance.drawAll(this.diagramLayer)}return Promise.resolve()}async tryLoadTestScript(){const e=new URLSearchParams(this.window.location.search);if(e.has("script")){const{default:t}=await import("./testScripts.js"),i=e.get("script");if(!(i in t))throw new Error(`${i} is not a known test script`);t[i](this.diagramLayer)}return Promise.resolve()}getSelectedComponent(){if(0===this.transformer.nodes().length)return null;const e=this.transformer.nodes().at(0);return DiagramState.instance.getComponent(e.id())}openPropertiesPanel(){this.elements.propertiesButton.click()}enterSelectMode(){this.elements.selectToolButton.click()}enterWireMode(){this.elements.wireToolButton.click()}findPinsInRect(e){return this.diagramLayer.find(".Pin").filter(t=>{const i=t.getClientRect(),n=new Konva.Rect({x:i.x,y:i.y,width:i.width,height:i.height});return Geometry.rectanglesOverlap(e,n)})}handleGlobalKeyCode(e){e.ctrlKey&&"Enter"===e.key&&(this.elements.visButton.click(),e.preventDefault())}handleSelectionKeyCode(e){if(0===this.transformer.nodes().length)return;const t=this.transformer.nodes().at(0);"Delete"===e||"Backspace"===e?this.deleteSelectedComponent(t):"KeyF"===e?this.flipSelectedSwitch(t):"KeyR"===e?this.rotateSelectedPot(t):"KeyP"===e?this.openPropertiesPanel():"Escape"===e?this.clearSelection():"KeyC"===e&&(this.cycleWireColors(),this.changeColor(t))}handleToolbarKeyCode(e){this.transformer.nodes().length>0||("KeyW"===e?this.enterWireMode():"KeyS"===e?this.enterSelectMode():"KeyC"===e&&this.cycleWireColors())}cycleWireColors(){this.lastWireColor++,this.lastWireColor>this.wireColors.length-1&&(this.lastWireColor=0);const e=this.wireColors.at(this.lastWireColor);this.document.getElementById("wire-color-"+e).click()}changeColor(e){const t=DiagramState.instance.getComponent(e.id());t.changeColor&&t.changeColor(e,DiagramState.instance.wireToolColor)}clearSelection(){this.elements.flipButton.disabled=!0,this.elements.rotateButton.disabled=!0,this.elements.propertiesButton.disabled=!0,this.transformer.nodes([])}flipSelectedSwitch(e){const t=DiagramState.instance.getComponent(e.id());t.can("flip")&&t.flip(e)}rotateSelectedPot(e){const t=DiagramState.instance.getComponent(e.id());t.can("rotate")&&t.rotate(e)}deleteSelectedComponent(e){if(confirm("Delete selected component?")){const t=DiagramState.instance.getComponent(e.id()),i=this.transformer.getLayer();t.removeFromDiagram(i),this.clearSelection()}}}window.GuitarWiringVisualizer=new App(window);

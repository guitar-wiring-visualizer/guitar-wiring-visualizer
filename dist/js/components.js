/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState,TOOL_MODE_WIRE}from"./diagram.js";import EventEmitter from"./eventEmitter.js";export class Component extends EventEmitter{constructor(t={}){super(),this._state=t,t.id||(t.id=DiagramState.instance.getNewIdentity(),DiagramState.instance.registerComponent(this)),t.nodeAttrs=t.nodeAttrs||{},t.pinIds=t.pinIds||[]}get id(){return this._state.id}get state(){return this._state}get pinIds(){return this._state.pinIds}get nodeAttrs(){return this._state.nodeAttrs}set nodeAttrs(t){this._state.nodeAttrs=t}static get ImageURL(){throw new Error("abstract method call")}static get IsDraggable(){return!0}findNode(t){return t.findOne("#"+this.id.toString())}createAsSubcomponent(t){const e=this._createShapeGroup(t);return this._populateGroup(e),this.nodeAttrs=e.attrs,this._subscribeToEvents(e),e}createOnLayer(t,e){const a=this._createShapeGroup(e);this._populateGroup(a),t.add(a),this.nodeAttrs=a.attrs,this._subscribeToEvents(a),DiagramState.instance.notifyNodeChanged(a)}drawOnLayer(t){const e=this._createShapeGroup(position);this._populateGroup(e),e.attrs=this.nodeAttrs,t.add(e),this._subscribeToEvents(e)}_subscribeToEvents(t){t.on("dragend transformend",e=>{this.nodeAttrs=t.attrs,this._moveAttachedWires(t)}),t.on("dragstart",e=>{DiagramState.instance.toolMode===TOOL_MODE_WIRE&&t.stopDrag()})}_createShapeGroup(t){return new Konva.Group({x:t.x,y:t.y,draggable:this.constructor.IsDraggable,name:this.constructor.name,id:this.id.toString()})}_populateGroup(t){throw new Error("abstract method call")}_applyGlobalStyling(t){t.shadowColor("black"),t.shadowBlur(6),t.shadowOffset({x:3,y:3}),t.shadowOpacity(.4)}removeFromDiagram(t){const e=this.findNode(t);e.destroy(),DiagramState.instance.notifyNodeChanged(e),DiagramState.instance.removeComponentById(this.id)}_moveAttachedWires(t){const e=t.getLayer();this.pinIds.forEach(t=>{const a=DiagramState.instance.getComponent(t).findNode(e).getAbsolutePosition();DiagramState.instance.findComponents(e=>"Wire"===e.constructor.name&&e.startPinId===t).forEach(t=>{new Wire({startPoint:[a.x,a.y],midPoint:t.midPoint,endPoint:t.endPoint,startPinId:t.startPinId,endPinId:t.endPinId,color:t.color,voltage:t.voltage}).createOnLayer(e),t.removeFromDiagram(e)});DiagramState.instance.findComponents(e=>"Wire"===e.constructor.name&&e.endPinId===t).forEach(t=>{new Wire({startPoint:t.startPoint,midPoint:t.midPoint,endPoint:[a.x,a.y],startPinId:t.startPinId,endPinId:t.endPinId,color:t.color,voltage:t.voltage}).createOnLayer(e),t.removeFromDiagram(e)})})}}export class Pin extends Component{constructor(t){super(t),this.state.voltage=t.voltage||0}static get IsDraggable(){return!1}get voltage(){return this.state.voltage}_setVoltage(t){this.state.voltage=t}_populateGroup(t){const e=new Konva.Circle({radius:6,stroke:"red",opacity:DiagramState.instance.showConnectors?1:0,strokeWidth:2});t.add(e)}_applyGlobalStyling(t){}receiveVoltage(t,e){this._setVoltage(e);DiagramState.instance.findComponents(e=>"Wire"==e.constructor.name&&e.id!==t&&(e.endPinId==this.id||e.startPinId==this.id)).forEach(t=>t.receiveVoltage(this.id,e)),this._emit("voltageChanged",this.voltage)}hasVoltage(){return 0!==this.voltage}}export class Wire extends Component{constructor(t){super(t),this.state.color=t.color||DiagramState.instance.WIRE_COLOR_DEFAULT,this.state.voltage=t.voltage||0}static get IsDraggable(){return!1}get startPinId(){return this.state.startPinId}get endPinId(){return this.state.endPinId}get startPoint(){return this.state.startPoint}get midPoint(){return this.state.midPoint}get endPoint(){return this.state.endPoint}get color(){return this.state.color}get voltage(){return this.state.voltage}_setVoltage(t){this.state.voltage=t}receiveVoltage(t,e){this._setVoltage(e);const a=this.startPinId===t?this.endPinId:this.startPinId;DiagramState.instance.getComponent(a).receiveVoltage(this.id,e)}hasVoltage(){return 0!==this.voltage}_createShapeGroup(t){const e=[...this.startPoint,...this.midPoint,...this.endPoint],a=new Konva.Line({points:e,stroke:this.color,strokeWidth:5,lineCap:"butt",lineJoin:"round",draggable:Wire.IsDraggable,tension:.7,id:this.id.toString(),name:this.constructor.name});return a.transformsEnabled("none"),a}_populateGroup(t){}_applyGlobalStyling(t){}changeColor(t,e){this.color=e,t.stroke(e)}}class InductionCoil{constructor(t,e){this._startPin=t,this._endPin=e}induct(){this._startPin.hasVoltage()?this._endPin.receiveVoltage(this._startPin.id,-this._startPin.voltage):this._endPin.hasVoltage()?this._startPin.receiveVoltage(this._endPin.id,-this._endPin.voltage):this._endPin.receiveVoltage(this._startPin.id,1)}}export class Pickup extends Component{constructor(t){super(t)}induct(){throw new Error("Abstract method call")}}export class Humbucker extends Pickup{constructor(t){super(t)}static get ImageURL(){return"/img/pu-humbucker4.svg"}induct(){}_populateGroup(t){const e=new Pin({}),a=e.createAsSubcomponent({x:5,y:165});t.add(a);const n=new Pin({}),s=n.createAsSubcomponent({x:17,y:180});t.add(s);const o=new Pin({}),r=o.createAsSubcomponent({x:33,y:182});t.add(r);const i=new Pin({}),c=i.createAsSubcomponent({x:50,y:173});t.add(c);const d=new Pin({}),g=d.createAsSubcomponent({x:60,y:158});t.add(g),this.pinIds.push(e.id,n.id,o.id,i.id,d.id),Konva.Image.fromURL(Humbucker.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),[a,s,r,c,g].forEach(t=>{t.zIndex(e.zIndex())})})}}export class StratPickup extends Pickup{constructor(t){super(t)}static get ImageURL(){return"/img/pu-strat.svg"}get startPin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get endPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}induct(){new InductionCoil(this.startPin,this.endPin).induct()}_populateGroup(t){const e=new Pin({}),a=e.createAsSubcomponent({x:140,y:105});t.add(a);const n=new Pin({}),s=n.createAsSubcomponent({x:159,y:105});t.add(s),this.pinIds.push(e.id,n.id),Konva.Image.fromURL(StratPickup.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),[a,s].forEach(t=>{t.zIndex(e.zIndex())})})}}export class Jack extends Component{constructor(t){super(t)}}export class MonoJack extends Jack{constructor(t){super(t);const e=new Pin({}),a=new Pin({});this.pinIds.push(e.id,a.id),e.on("voltageChanged",t=>{a.hasVoltage()||a.receiveVoltage(this.id,-t)}),a.on("voltageChanged",t=>{e.hasVoltage()||e.receiveVoltage(this.id,-t)})}static get ImageURL(){return"/img/jack-mono.svg"}get tipPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get sleevePin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}_populateGroup(t){const e=this.tipPin,a=this.sleevePin,n=e.createAsSubcomponent({x:47,y:10});t.add(n);const s=a.createAsSubcomponent({x:48,y:31});t.add(s),Konva.Image.fromURL(MonoJack.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),[n,s].forEach(t=>{t.zIndex(e.zIndex())})})}}export class Switch extends Component{constructor(t){super(t),this.state.actuatorState=this.state.actuatorState||0}get actuatorState(){return this.state.actuatorState}_setActuatorState(t){this.state.actuatorState=t}flip(t){this._flipActuator(t)}_flipActuator(){throw new Error("abstract method call")}_addActuator(t){}}export class DPDTSwitch extends Switch{constructor(t){super(t)}static get _pinsStartAtX(){return 10}static get _pinsStartAtY(){return 9}_populateGroup(t){const e=[[]];for(let a=0;a<3;a++){e.push([]);for(let n=0;n<2;n++){const s=new Pin({});this.pinIds.push(s.id);const o=s.createAsSubcomponent({x:DPDTSwitch._pinsStartAtX+22*n,y:DPDTSwitch._pinsStartAtY+15*a});e[a].push(o),t.add(o)}}Konva.Image.fromURL(this.constructor.ImageURL,a=>{this._applyGlobalStyling(a),t.add(a),e.forEach(t=>{t.forEach(t=>{t.zIndex(a.zIndex())})})}),this._addActuator(t)}}export class DPDTOnOn extends DPDTSwitch{constructor(t){super(t)}static get ImageURL(){return"/img/dpdt-blue.svg"}_getActuatorImageURLForState(){return 0===this.actuatorState?"/img/bat-small-left.svg":"/img/bat-small-right.svg"}_addActuator(t){Konva.Image.fromURL(this._getActuatorImageURLForState(),e=>{e.position({x:0,y:-35}),e.name("switch-actuator"),this._applyGlobalStyling(e),t.add(e)})}_flipActuator(t){this._setActuatorState(0===this.actuatorState?1:0);const e=t.getChildren().filter(t=>"switch-actuator"===t.name())[0],a=e.position();e.destroy(),Konva.Image.fromURL(this._getActuatorImageURLForState(),e=>{e.position(a),this._applyGlobalStyling(e),e.name("switch-actuator"),t.add(e)})}}export class DPDTOnOffOn extends DPDTSwitch{constructor(t){super(t)}static get ImageURL(){return"/img/dpdt-purple.svg"}}export class DPDTOnOnOn extends DPDTSwitch{constructor(t){super(t)}static get ImageURL(){return"/img/dpdt-red.svg"}}export class Potentiometer extends Component{constructor(t){super(t)}static get ImageURL(){return"/img/pot1.svg"}static get _pinsStartAtX(){return 25}static get _pinsStartAtY(){return 110}_populateGroup(t){const e=[];for(let a=0;a<3;a++){const n=new Pin({});this.pinIds.push(n.id);const s=n.createAsSubcomponent({x:Potentiometer._pinsStartAtX+24*a,y:Potentiometer._pinsStartAtY});e.push(s),t.add(s)}Konva.Image.fromURL(Potentiometer.ImageURL,a=>{this._applyGlobalStyling(a),t.add(a),e.forEach(t=>{t.zIndex(a.zIndex())})})}}

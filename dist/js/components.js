/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState,TOOL_MODE_WIRE}from"./diagram.js";import EventEmitter from"./eventEmitter.js";export class Component extends EventEmitter{constructor(t){super(),this._state=t,t.id||(t.id=DiagramState.instance.getNewIdentity(),DiagramState.instance.registerComponent(this),t.nodeAttrs=t.nodeAttrs||{},t.pinIds=t.pinIds||[],this._createChildComponents())}get id(){return this._state.id}get state(){return this._state}get pinIds(){return this._state.pinIds}get nodeAttrs(){return this._state.nodeAttrs}set nodeAttrs(t){this._state.nodeAttrs=t}static get ImageURL(){throw new Error("abstract method call")}static get IsDraggable(){return!0}moveTo(t){this.nodeAttrs.x=t.x,this.nodeAttrs.y=t.y}draw(t){const e=this._getPosition(),n=this._createRootNode(e);this._drawChildNodes(n),t.add(n),this.nodeAttrs=n.attrs,this._subscribeToEvents(n),DiagramState.instance.notifyNodeChanged(n)}removeFromDiagram(t){const e=this.findNode(t);e.destroy(),DiagramState.instance.notifyNodeChanged(e),DiagramState.instance.removeComponentById(this.id)}findNode(t){return t.findOne("#"+this.id.toString())}_getPosition(){return{x:this.nodeAttrs.x,y:this.nodeAttrs.y}}getNode(t){return t.findOne("#"+this.id.toString())}_getPinNodes(t){return this.pinIds.map(e=>DiagramState.instance.getComponent(e).getNode(t))}_subscribeToEvents(t){t.on("dragend transformend",e=>{this.state.nodeAttrs=t.attrs,this._moveAttachedWires(t)}),t.on("dragstart",e=>{DiagramState.instance.toolMode===TOOL_MODE_WIRE&&t.stopDrag()})}_createChildComponents(){}_createRootNode(){return new Konva.Group({x:this.nodeAttrs.x,y:this.nodeAttrs.y,draggable:this.constructor.IsDraggable,name:this.constructor.name,id:this.id.toString()})}_drawChildNodes(t){}_applyGlobalStyling(t){t.shadowColor("black"),t.shadowBlur(6),t.shadowOffset({x:3,y:3}),t.shadowOpacity(.4)}_moveAttachedWires(t){const e=t.getLayer();this.pinIds.forEach(t=>{const n=DiagramState.instance.getComponent(t).findNode(e).getAbsolutePosition();DiagramState.instance.findComponents(e=>"Wire"===e.constructor.name&&e.startPinId===t).forEach(t=>{new Wire({startPoint:[n.x,n.y],midPoint:t.midPoint,endPoint:t.endPoint,startPinId:t.startPinId,endPinId:t.endPinId,color:t.color,voltage:t.voltage}).draw(e),t.removeFromDiagram(e)});DiagramState.instance.findComponents(e=>"Wire"===e.constructor.name&&e.endPinId===t).forEach(t=>{new Wire({startPoint:t.startPoint,midPoint:t.midPoint,endPoint:[n.x,n.y],startPinId:t.startPinId,endPinId:t.endPinId,color:t.color,voltage:t.voltage}).draw(e),t.removeFromDiagram(e)})})}}export class Pin extends Component{constructor(t={}){super(t),this.state.voltage=t.voltage||0}static get IsDraggable(){return!1}get voltage(){return this.state.voltage}_setVoltage(t){this.state.voltage=t}_drawChildNodes(t){const e=new Konva.Circle({radius:6,stroke:"red",opacity:DiagramState.instance.showConnectors?1:0,strokeWidth:2});t.add(e)}_applyGlobalStyling(t){}receiveVoltage(t,e){this._setVoltage(e);DiagramState.instance.findComponents(e=>"Wire"==e.constructor.name&&e.id!==t&&(e.endPinId==this.id||e.startPinId==this.id)).forEach(t=>t.receiveVoltage(this.id,e)),this._emit("voltageChanged",this.voltage)}hasVoltage(){return 0!==this.voltage}}export class Wire extends Component{constructor(t={}){super(t),this.state.color=t.color||DiagramState.instance.WIRE_COLOR_DEFAULT,this.state.voltage=t.voltage||0}static get IsDraggable(){return!1}get startPinId(){return this.state.startPinId}get endPinId(){return this.state.endPinId}get startPoint(){return this.state.startPoint}get midPoint(){return this.state.midPoint}get endPoint(){return this.state.endPoint}get color(){return this.state.color}moveTo(t){super.moveTo(t)}get voltage(){return this.state.voltage}_setVoltage(t){this.state.voltage=t}receiveVoltage(t,e){this._setVoltage(e);const n=this.startPinId===t?this.endPinId:this.startPinId;DiagramState.instance.getComponent(n).receiveVoltage(this.id,e)}hasVoltage(){return 0!==this.voltage}_createRootNode(t){const e=[...this.startPoint,...this.midPoint,...this.endPoint],n=new Konva.Line({points:e,stroke:this.color,strokeWidth:5,lineCap:"butt",lineJoin:"round",draggable:Wire.IsDraggable,tension:.7,id:this.id.toString(),name:this.constructor.name});return n.transformsEnabled("none"),n}_drawChildNodes(t){}_applyGlobalStyling(t){}changeColor(t,e){this.color=e,t.stroke(e)}}class InductionCoil{constructor(t,e){this._startPin=t,this._endPin=e}induct(){this._startPin.hasVoltage()?this._endPin.receiveVoltage(this._startPin.id,-this._startPin.voltage):this._endPin.hasVoltage()?this._startPin.receiveVoltage(this._endPin.id,-this._endPin.voltage):this._endPin.receiveVoltage(this._startPin.id,1)}}export class Pickup extends Component{constructor(t={}){super(t)}induct(){throw new Error("Abstract method call")}}export class Humbucker extends Pickup{constructor(t={}){super(t)}static get ImageURL(){return"/img/pu-humbucker4.svg"}induct(){}get topCoilStartPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get topCoilEndPin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get bottomCoilEndPin(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get bottomCoilStartPin(){return DiagramState.instance.getComponent(this.pinIds.at(3))}get groundPin(){return DiagramState.instance.getComponent(this.pinIds.at(4))}_createChildComponents(){const t=new Pin,e=new Pin,n=new Pin,i=new Pin,a=new Pin;this.pinIds.push(e.id,t.id,n.id,i.id,a.id)}_drawChildNodes(t){this.topCoilEndPin.moveTo({x:5,y:165}),this.topCoilEndPin.draw(t),this.topCoilStartPin.moveTo({x:17,y:180}),this.topCoilStartPin.draw(t),this.bottomCoilEndPin.moveTo({x:33,y:182}),this.bottomCoilEndPin.draw(t),this.bottomCoilStartPin.moveTo({x:50,y:173}),this.bottomCoilStartPin.draw(t),this.groundPin.moveTo({x:60,y:158}),this.groundPin.draw(t),Konva.Image.fromURL(Humbucker.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))})}}export class StratPickup extends Pickup{constructor(t={}){super(t)}static get ImageURL(){return"/img/pu-strat.svg"}get startPin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get endPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}induct(){new InductionCoil(this.startPin,this.endPin).induct()}_createChildComponents(){const t=new Pin,e=new Pin;this.pinIds.push(t.id,e.id)}_drawChildNodes(t){this.endPin.moveTo({x:140,y:105}),this.endPin.draw(t),this.startPin.moveTo({x:159,y:105}),this.startPin.draw(t),Konva.Image.fromURL(StratPickup.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))})}}export class Jack extends Component{constructor(t={}){super(t)}}export class MonoJack extends Jack{constructor(t={}){super(t)}static get ImageURL(){return"/img/jack-mono.svg"}get tipPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get sleevePin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}_createChildComponents(){const t=new Pin,e=new Pin;this.pinIds.push(t.id,e.id),t.on("voltageChanged",t=>{e.hasVoltage()||e.receiveVoltage(this.id,-t)}),e.on("voltageChanged",e=>{t.hasVoltage()||t.receiveVoltage(this.id,-e)})}_drawChildNodes(t){this.tipPin.moveTo({x:47,y:10}),this.tipPin.draw(t),this.sleevePin.moveTo({x:48,y:31}),this.sleevePin.draw(t),Konva.Image.fromURL(MonoJack.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))})}}export class Switch extends Component{constructor(t={}){super(t),this.state.actuatorState=this.state.actuatorState||0}get actuatorState(){return this.state.actuatorState}_setActuatorState(t){this.state.actuatorState=t}flip(t){this._flipActuator(t)}_flipActuator(){throw new Error("abstract method call")}_addActuator(t){}}export class DPDTSwitch extends Switch{constructor(t={}){super(t)}static get _pinsStartAtX(){return 10}static get _pinsStartAtY(){return 9}get pin6(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get pin3(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get pin5(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get pin2(){return DiagramState.instance.getComponent(this.pinIds.at(3))}get pin4(){return DiagramState.instance.getComponent(this.pinIds.at(4))}get pin1(){return DiagramState.instance.getComponent(this.pinIds.at(5))}_createChildComponents(){for(let t=0;t<3;t++)for(let e=0;e<2;e++){const n=new Pin;this.pinIds.push(n.id),n.moveTo({x:DPDTSwitch._pinsStartAtX+22*e,y:DPDTSwitch._pinsStartAtY+15*t})}}_drawChildNodes(t){this.pin1.draw(t),this.pin2.draw(t),this.pin3.draw(t),this.pin4.draw(t),this.pin5.draw(t),this.pin6.draw(t),Konva.Image.fromURL(this.constructor.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))}),this._addActuator(t)}}export class DPDTOnOn extends DPDTSwitch{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-blue.svg"}_getActuatorImageURLForState(){return 0===this.actuatorState?"/img/bat-small-left.svg":"/img/bat-small-right.svg"}_addActuator(t){Konva.Image.fromURL(this._getActuatorImageURLForState(),e=>{e.position({x:0,y:-35}),e.name("switch-actuator"),this._applyGlobalStyling(e),t.add(e)})}_flipActuator(t){this._setActuatorState(0===this.actuatorState?1:0);const e=t.getChildren().filter(t=>"switch-actuator"===t.name())[0],n=e.position();e.destroy(),Konva.Image.fromURL(this._getActuatorImageURLForState(),e=>{e.position(n),this._applyGlobalStyling(e),e.name("switch-actuator"),t.add(e)})}}export class DPDTOnOffOn extends DPDTSwitch{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-purple.svg"}}export class DPDTOnOnOn extends DPDTSwitch{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-red.svg"}}export class Potentiometer extends Component{constructor(t={}){super(t)}static get ImageURL(){return"/img/pot1.svg"}static get _pinsStartAtX(){return 25}static get _pinsStartAtY(){return 110}get startPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get endPin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get wiperPin(){return DiagramState.instance.getComponent(this.pinIds.at(2))}_createChildComponents(){for(let t=0;t<3;t++){const e=new Pin;this.pinIds.push(e.id),e.moveTo({x:Potentiometer._pinsStartAtX+24*t,y:Potentiometer._pinsStartAtY})}}_drawChildNodes(t){this.startPin.draw(t),this.endPin.draw(t),this.wiperPin.draw(t),Konva.Image.fromURL(Potentiometer.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))})}}export const componentClassMap={Potentiometer:Potentiometer,DPDTOnOn:DPDTOnOn,DPDTOnOffOn:DPDTOnOffOn,DPDTOnOnOn:DPDTOnOnOn,Humbucker:Humbucker,StratPickup:StratPickup,MonoJack:MonoJack};

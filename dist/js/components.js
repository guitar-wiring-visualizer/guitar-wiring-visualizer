/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState,TOOL_MODE_WIRE}from"./diagram.js";export class Component{constructor(t={}){t._id?this._id=t._id:(this._id=DiagramState.instance.getNewIdentity(),DiagramState.instance.registerComponent(this)),this._nodeAttrs=t._nodeAttrs||{},this._pins=t._pins||[]}get id(){return this._id}get pinIds(){return this._pins}static get ImageURL(){throw new Error("abstract method call")}static get IsDraggable(){return!0}createAsSubcomponent(t){const e=this._createShapeGroup(t);return this._populateGroup(e),this._nodeAttrs=e.attrs,this._subscribeToEvents(e),e}createOnLayer(t,e){const n=this._createShapeGroup(e);this._populateGroup(n),t.add(n),this._nodeAttrs=n.attrs,this._subscribeToEvents(n),DiagramState.instance.notifyNodeChanged(n)}drawOnLayer(t){const e=this._createShapeGroup(position);this._populateGroup(e),e.attrs=this._nodeAttrs,t.add(e),this._subscribeToEvents(e)}_subscribeToEvents(t){t.on("dragend transformend",e=>{this._nodeAttrs=t.attrs,this._moveAttachedWires(t)}),t.on("dragstart",e=>{DiagramState.instance.toolMode===TOOL_MODE_WIRE&&t.stopDrag()})}_createShapeGroup(t){return new Konva.Group({x:t.x,y:t.y,draggable:this.constructor.IsDraggable,name:this.constructor.name,id:this.id.toString()})}_populateGroup(t){throw new Error("abstract method call")}_applyGlobalStyling(t){t.shadowColor("black"),t.shadowBlur(6),t.shadowOffset({x:3,y:3}),t.shadowOpacity(.4)}removeFromDiagram(t){const e=t.findOne("#"+this.id.toString());e.destroy(),DiagramState.instance.notifyNodeChanged(e),DiagramState.instance.removeComponentById(this.id)}_moveAttachedWires(t){const e=t.getLayer();this._pins.forEach(t=>{const n=e.find("#"+t.toString()).at(0).getAbsolutePosition();DiagramState.instance.findComponents(e=>"Wire"===e.constructor.name&&e.startPinId===t).forEach(t=>{new Wire({_startPoint:[n.x,n.y],_midPoint:t.midPoint,_endPoint:t.endPoint,_startPinId:t.startPinId,_endPinId:t.endPinId,_color:t.color}).createOnLayer(e),t.removeFromDiagram(e)});DiagramState.instance.findComponents(e=>"Wire"===e.constructor.name&&e.endPinId===t).forEach(t=>{new Wire({_startPoint:t.startPoint,_midPoint:t.midPoint,_endPoint:[n.x,n.y],_startPinId:t.startPinId,_endPinId:t.endPinId,_color:t.color}).createOnLayer(e),t.removeFromDiagram(e)})})}}export class Pickup extends Component{constructor(t){super(t)}}export class Humbucker extends Pickup{constructor(t){super(t)}static get ImageURL(){return"/img/pu-humbucker4.svg"}_populateGroup(t){const e=new Pin({}),n=e.createAsSubcomponent({x:5,y:165});t.add(n);const o=new Pin({}),r=o.createAsSubcomponent({x:17,y:180});t.add(r);const a=new Pin({}),s=a.createAsSubcomponent({x:33,y:182});t.add(s);const i=new Pin({}),c=i.createAsSubcomponent({x:50,y:173});t.add(c);const d=new Pin({}),p=d.createAsSubcomponent({x:60,y:158});t.add(p),this._pins.push(e.id,o.id,a.id,i.id,d.id),Konva.Image.fromURL(Humbucker.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),[n,r,s,c,p].forEach(t=>{t.zIndex(e.zIndex())})})}}export class StratPickup extends Pickup{constructor(t){super(t)}static get ImageURL(){return"/img/pu-strat.svg"}_populateGroup(t){const e=new Pin({}),n=e.createAsSubcomponent({x:140,y:105});t.add(n);const o=new Pin({}),r=o.createAsSubcomponent({x:159,y:105});t.add(r),this._pins.push(e.id,o.id),Konva.Image.fromURL(StratPickup.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),[n,r].forEach(t=>{t.zIndex(e.zIndex())})})}}export class Jack extends Component{constructor(t){super(t)}}export class MonoJack extends Jack{constructor(t){super(t)}static get ImageURL(){return"/img/jack-mono.svg"}_populateGroup(t){const e=new Pin({}),n=e.createAsSubcomponent({x:47,y:10});t.add(n);const o=new Pin({}),r=o.createAsSubcomponent({x:48,y:31});t.add(r),this._pins.push(e.id,o.id),Konva.Image.fromURL(MonoJack.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),[n,r].forEach(t=>{t.zIndex(e.zIndex())})})}}export class Pin extends Component{constructor(t){super(t)}static get IsDraggable(){return!1}_populateGroup(t){const e=new Konva.Circle({radius:6,stroke:"red",opacity:DiagramState.instance.showConnectors?1:0,strokeWidth:2});t.add(e)}_applyGlobalStyling(t){}}export class Wire extends Component{constructor(t){super(t),this._startPoint=t._startPoint,this._endPoint=t._endPoint,this._midPoint=t._midPoint,this._startPinId=t._startPinId,this._endPinId=t._endPinId,this._color=t._color||DiagramState.instance.WIRE_COLOR_DEFAULT}static get IsDraggable(){return!1}get startPinId(){return this._startPinId}get endPinId(){return this._endPinId}get startPoint(){return this._startPoint}get midPoint(){return this._midPoint}get endPoint(){return this._endPoint}get color(){return this._color}_createShapeGroup(t){const e=[...this._startPoint,...this._midPoint,...this._endPoint],n=new Konva.Line({points:e,stroke:this._color,strokeWidth:5,lineCap:"butt",lineJoin:"round",draggable:Wire.IsDraggable,tension:.7,id:this.id.toString(),name:this.constructor.name});return n.transformsEnabled("none"),n}_populateGroup(t){}_applyGlobalStyling(t){}changeColor(t,e){this._color=e,t.stroke(e)}}export class Switch extends Component{constructor(t){super(t)}flip(t){this._flipActuator(t)}_flipActuator(){throw new Error("abstract method call")}_addActuator(t){}}export class DPDTSwitch extends Switch{constructor(t){super(t)}static get _pinsStartAtX(){return 10}static get _pinsStartAtY(){return 9}_populateGroup(t){const e=[[]];for(let n=0;n<3;n++){e.push([]);for(let o=0;o<2;o++){const r=new Pin({});this._pins.push(r.id);const a=r.createAsSubcomponent({x:DPDTSwitch._pinsStartAtX+22*o,y:DPDTSwitch._pinsStartAtY+15*n});e[n].push(a),t.add(a)}}Konva.Image.fromURL(this.constructor.ImageURL,n=>{this._applyGlobalStyling(n),t.add(n),e.forEach(t=>{t.forEach(t=>{t.zIndex(n.zIndex())})})}),this._addActuator(t)}}export class DPDTOnOn extends DPDTSwitch{constructor(t){super(t),this._actuatorState=0}static get ImageURL(){return"/img/dpdt-blue.svg"}_getActuatorImageURLForState(){return 0===this._actuatorState?"/img/bat-small-left.svg":"/img/bat-small-right.svg"}_addActuator(t){Konva.Image.fromURL(this._getActuatorImageURLForState(),e=>{e.position({x:0,y:-35}),e.name("switch-actuator"),this._applyGlobalStyling(e),t.add(e)})}_flipActuator(t){this._actuatorState=0===this._actuatorState?1:0;const e=t.getChildren().filter(t=>"switch-actuator"===t.name())[0],n=e.position();e.destroy(),Konva.Image.fromURL(this._getActuatorImageURLForState(),e=>{e.position(n),this._applyGlobalStyling(e),e.name("switch-actuator"),t.add(e)})}}export class DPDTOnOffOn extends DPDTSwitch{constructor(t){super(t),this._actuatorState=0}static get ImageURL(){return"/img/dpdt-purple.svg"}}export class DPDTOnOnOn extends DPDTSwitch{constructor(t){super(t),this._actuatorState=0}static get ImageURL(){return"/img/dpdt-red.svg"}}export class Potentiometer extends Component{constructor(t){super(t)}static get ImageURL(){return"/img/pot1.svg"}static get _pinsStartAtX(){return 25}static get _pinsStartAtY(){return 110}_populateGroup(t){const e=[];for(let n=0;n<3;n++){const o=new Pin({});this._pins.push(o.id);const r=o.createAsSubcomponent({x:Potentiometer._pinsStartAtX+24*n,y:Potentiometer._pinsStartAtY});e.push(r),t.add(r)}Konva.Image.fromURL(Potentiometer.ImageURL,n=>{this._applyGlobalStyling(n),t.add(n),e.forEach(t=>{t.zIndex(n.zIndex())})})}}

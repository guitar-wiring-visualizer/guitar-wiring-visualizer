import {DiagramState as a,TOOL_MODE_WIRE as b,} from'./diagram.js';export class Component{constructor(A={}){A._id?(this._id=A._id):(this._id=a.instance.getNewIdentity(),a.instance.registerComponent(this));this._nodeAttrs=A._nodeAttrs||{};this._pins=A._pins||[]}get id(){return this._id}get pinIds(){return this._pins}static get ImageURL(){throw Error('abstract method call')}static get IsDraggable(){return!0}createAsSubcomponent(_){let B=this._createShapeGroup(_);this._populateGroup(B);this._nodeAttrs=B.attrs;this._subscribeToEvents(B);return B}createOnLayer(C,_b){let _c=this._createShapeGroup(_b);this._populateGroup(_c);C.add(_c);this._nodeAttrs=_c.attrs;this._subscribeToEvents(_c);a.instance.notifyNodeChanged(_c)}drawOnLayer(_a){let d=this._createShapeGroup(position);this._populateGroup(d);d.attrs=this._nodeAttrs;_a.add(d);this._subscribeToEvents(d)}_subscribeToEvents(D){D.on('dragend transformend',e=>{this._nodeAttrs=D.attrs;this._moveAttachedWires(D)});D.on('dragstart',()=>{a.instance.toolMode===b&&D.stopDrag()})}_createShapeGroup(_A){return new Konva.Group({x:_A.x,y:_A.y,draggable:this.constructor.IsDraggable,name:this.constructor.name,id:`${this.id}`})}_populateGroup(){throw Error('abstract method call')}_applyGlobalStyling(e){e.shadowColor('black');e.shadowBlur(6);e.shadowOffset({x:3,y:3});e.shadowOpacity(0.4)}removeFromDiagram(E){let _B=E.findOne('#'+`${this.id}`);_B.destroy();a.instance.notifyNodeChanged(_B);a.instance.removeComponentById(this.id)}_moveAttachedWires(aA){let aB=aA.getLayer();for(const pinId of this._pins){let aC=aB.find('#'+`${pinId}`).at(0),aD=aC.getAbsolutePosition(),_C=a.instance.findComponents(c=>c.constructor.name==='Wire'&&c.startPinId===pinId);for(const aE of _C){let aF=new Wire({_startPoint:[aD.x,aD.y],_midPoint:aE.midPoint,_endPoint:aE.endPoint,_startPinId:aE.startPinId,_endPinId:aE.endPinId,_color:aE.color});aF.createOnLayer(aB);aE.removeFromDiagram(aB)}let _d=a.instance.findComponents(c=>c.constructor.name==='Wire'&&c.endPinId===pinId);for(const aG of _d){let aH=new Wire({_startPoint:aG.startPoint,_midPoint:aG.midPoint,_endPoint:[aD.x,aD.y],_startPinId:aG.startPinId,_endPinId:aG.endPinId,_color:aG.color});aH.createOnLayer(aB);aG.removeFromDiagram(aB)}}}}export class Pickup extends Component{constructor(aI){super(aI)}}export class Humbucker extends Pickup{constructor(aJ){super(aJ)}static get ImageURL(){return'/img/pu-humbucker4.svg'}_populateGroup(aK){let aL=new Pin({});let aM=aL.createAsSubcomponent({x:5,y:165}),_e=_D.createAsSubcomponent({x:17,y:180}),g=f.createAsSubcomponent({x:33,y:182}),i=h.createAsSubcomponent({x:50,y:173}),k=j.createAsSubcomponent({x:60,y:158});aK.add(aM);let _D=new Pin({});aK.add(_e);let f=new Pin({});aK.add(g);let h=new Pin({});aK.add(i);let j=new Pin({});aK.add(k);this._pins.push(aL.id,_D.id,f.id,h.id,j.id);Konva.Image.fromURL(Humbucker.ImageURL,aN=>{this._applyGlobalStyling(aN);aK.add(aN);for(const p of [aM,_e,g,i,k])p.zIndex(aN.zIndex())})}}export class StratPickup extends Pickup{constructor(aO){super(aO)}static get ImageURL(){return'/img/pu-strat.svg'}_populateGroup(aP){let aQ=new Pin({});let aR=aQ.createAsSubcomponent({x:140,y:105}),_E=aS.createAsSubcomponent({x:159,y:105});aP.add(aR);let aS=new Pin({});aP.add(_E);this._pins.push(aQ.id,aS.id);Konva.Image.fromURL(StratPickup.ImageURL,aT=>{this._applyGlobalStyling(aT);aP.add(aT);for(const p of [aR,_E])p.zIndex(aT.zIndex())})}}export class Jack extends Component{constructor(aU){super(aU)}}export class MonoJack extends Jack{constructor(aV){super(aV)}static get ImageURL(){return'/img/jack-mono.svg'}_populateGroup(aW){let aX=new Pin({});let aY=aX.createAsSubcomponent({x:47,y:10}),bA=aZ.createAsSubcomponent({x:48,y:31});aW.add(aY);let aZ=new Pin({});aW.add(bA);this._pins.push(aX.id,aZ.id);Konva.Image.fromURL(MonoJack.ImageURL,bB=>{this._applyGlobalStyling(bB);aW.add(bB);for(const p of [aY,bA])p.zIndex(bB.zIndex())})}}export class Pin extends Component{constructor(bC){super(bC)}static get IsDraggable(){return!1}_populateGroup(bD){bD.add(new Konva.Circle({radius:6,stroke:'red',opacity:a.instance.showConnectors?1:0,strokeWidth:2}))}_applyGlobalStyling(){}}export class Wire extends Component{constructor(bE){super(bE);this._startPoint=bE._startPoint;this._endPoint=bE._endPoint;this._midPoint=bE._midPoint;this._startPinId=bE._startPinId;this._endPinId=bE._endPinId;this._color=bE._color||a.instance.WIRE_COLOR_DEFAULT}static get IsDraggable(){return!1}get startPinId(){return this._startPinId}get endPinId(){return this._endPinId}get startPoint(){return this._startPoint}get midPoint(){return this._midPoint}get endPoint(){return this._endPoint}get color(){return this._color}_createShapeGroup(){let bF=[...this._startPoint,...this._midPoint,...this._endPoint];let bG=new Konva.Line({points:bF,stroke:this._color,strokeWidth:5,lineCap:'butt',lineJoin:'round',draggable:Wire.IsDraggable,tension:.7,id:`${this.id}`,name:this.constructor.name});bG.transformsEnabled('none');return bG}_populateGroup(){}_applyGlobalStyling(){}changeColor(bH,bI){this._color=bI;bH.stroke(bI)}}export class Switch extends Component{constructor(bJ){super(bJ)}flip(bK){this._flipActuator(bK)}_flipActuator(){throw Error('abstract method call')}_addActuator(){}}export class DPDTSwitch extends Switch{constructor(bL){super(bL)}static get _pinsStartAtX(){return 10}static get _pinsStartAtY(){return 9}_populateGroup(bM){let bN=3,bO=2,bP=[[]];for(let bQ=0;bQ<bN;bQ++){bP.push([]);for(let bR=0;bR<bO;bR++){const bS=new Pin({});this._pins.push(bS.id);const bT=bS.createAsSubcomponent({x:DPDTSwitch._pinsStartAtX+(bR*22),y:DPDTSwitch._pinsStartAtY+(bQ*15)});bP[bQ].push(bT);bM.add(bT)}}Konva.Image.fromURL(this.constructor.ImageURL,bU=>{this._applyGlobalStyling(bU);bM.add(bU);for(const pr of bP)for(const p of pr)p.zIndex(bU.zIndex())});this._addActuator(bM)}}export class DPDTOnOn extends DPDTSwitch{constructor(bV){super(bV);this._actuatorState=0}static get ImageURL(){return'/img/dpdt-blue.svg'}_getActuatorImageURLForState(){return this._actuatorState===0?'/img/bat-small-left.svg':'/img/bat-small-right.svg'}_addActuator(bW){Konva.Image.fromURL(this._getActuatorImageURLForState(),bX=>{bX.position({x:0,y:-35});bX.name('switch-actuator');this._applyGlobalStyling(bX);bW.add(bX)})}_flipActuator(bY){this._actuatorState=this._actuatorState===0?1:0;let bZ=bY.getChildren().filter(c=>c.name()==='switch-actuator')[0],cA=bZ.position();bZ.destroy();Konva.Image.fromURL(this._getActuatorImageURLForState(),cB=>{cB.position(cA);this._applyGlobalStyling(cB);cB.name('switch-actuator');bY.add(cB)})}}export class DPDTOnOffOn extends DPDTSwitch{constructor(cC){super(cC);this._actuatorState=0}static get ImageURL(){return'/img/dpdt-purple.svg'}}export class DPDTOnOnOn extends DPDTSwitch{constructor(cD){super(cD);this._actuatorState=0}static get ImageURL(){return'/img/dpdt-red.svg'}}export class Potentiometer extends Component{constructor(cE){super(cE)}static get ImageURL(){return'/img/pot1.svg'}static get _pinsStartAtX(){return 25}static get _pinsStartAtY(){return 110}_populateGroup(cF){let cG=3,cH=[];for(let p=0;p<cG;p++){const cI=new Pin({});this._pins.push(cI.id);const cJ=cI.createAsSubcomponent({x:Potentiometer._pinsStartAtX+(p*24),y:Potentiometer._pinsStartAtY});cH.push(cJ);cF.add(cJ)}Konva.Image.fromURL(Potentiometer.ImageURL,cK=>{this._applyGlobalStyling(cK);cF.add(cK);for(const p of cH)p.zIndex(cK.zIndex())})}}

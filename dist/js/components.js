/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState,TOOL_MODE_WIRE}from"./diagram.js";import EventEmitter from"./eventEmitter.js";export class Component extends EventEmitter{constructor(t){super(),this._state=t,t.id||(t.id=DiagramState.instance.getNewIdentity(),t.className=this.constructor.name,DiagramState.instance.registerComponent(this),t.nodeAttrs=t.nodeAttrs||{},t.pinIds=t.pinIds||[],this._createChildComponents())}get fullName(){return this.state.label?`${this.state.label} ${this.constructor.name} (${this.id})`:`${this.constructor.name} (${this.id})`}get id(){return this._state.id}get state(){return this._state}get pinIds(){return this._state.pinIds}get nodeAttrs(){return this._state.nodeAttrs}set nodeAttrs(t){this._state.nodeAttrs=t}static get ImageURL(){throw new Error("abstract method call")}static get IsDraggable(){return!0}moveTo(t){this.nodeAttrs.x=t.x,this.nodeAttrs.y=t.y}draw(t){const e=this._getPosition(),n=this._createRootNode(e);t.add(n),this._drawChildNodes(n),this.nodeAttrs=n.attrs,this._subscribeToEvents(n),DiagramState.instance.notifyNodeChanged(n)}_drawIDLabel(t){const e=new Konva.Label({x:0,y:0,opacity:.75});e.add(new Konva.Tag({fill:"yellow"})),e.add(new Konva.Text({text:this.id.toString(),fontFamily:"Calibri",fontSize:18,padding:5,fill:"black"})),"Group"===t.getClassName()&&t.add(e)}reDraw(t){this._unDrawIfNeeded(t),this.draw(t)}_unDrawIfNeeded(t){const e=this.findNode(t);e&&e.destroy()}removeFromDiagram(t){const e=this.findNode(t);e.destroy(),DiagramState.instance.notifyNodeChanged(e),DiagramState.instance.removeComponentById(this.id)}findNode(t){return t.findOne("#"+this.id.toString())}_getPosition(){return{x:this.nodeAttrs.x,y:this.nodeAttrs.y}}_getPinNodes(t){return this.pinIds.map(e=>DiagramState.instance.getComponent(e).findNode(t))}_subscribeToEvents(t){t.on("dragend transformend",e=>{this.state.nodeAttrs=t.attrs,this._moveAttachedWires(t)}),t.on("dragstart",e=>{DiagramState.instance.toolMode===TOOL_MODE_WIRE&&t.stopDrag()})}_createChildComponents(){}_createRootNode(){return new Konva.Group({x:this.nodeAttrs.x,y:this.nodeAttrs.y,draggable:this.constructor.IsDraggable,name:this.constructor.name,id:this.id.toString()})}_drawChildNodes(t){}_applyGlobalStyling(t){t.shadowColor("black"),t.shadowBlur(6),t.shadowOffset({x:3,y:3}),t.shadowOpacity(.4)}_moveAttachedWires(t){const e=t.getLayer();this.pinIds.forEach(t=>{const n=DiagramState.instance.getComponent(t).findNode(e).getAbsolutePosition();DiagramState.instance.findComponentsOfType(Wire,e=>e.startPinId===t).forEach(t=>{t.updateStartPoint([n.x,n.y]),t.reDraw(e)});DiagramState.instance.findComponentsOfType(Wire,e=>e.endPinId===t).forEach(t=>{t.updateEndPoint([n.x,n.y]),t.reDraw(e)})})}}export class Pin extends Component{constructor(t={}){super(t),this._voltage=0,this.state.connectedPinId=null,this.state.isConnectedPinSource=!1}static get IsDraggable(){return!1}get connectedPinId(){return this.state.connectedPinId}_setConnectedPinId(t){this.state.connectedPinId=t}get isConnectedPinSource(){return this.state.isConnectedPinSource}_setIsConnectedPinSource(t){this.state.isConnectedPinSource=t}connectToOtherPin(t){this._setIsConnectedPinSource(!0),this._setConnectedPinId(t.id),t._setConnectedPinId(this.id),t._setIsConnectedPinSource(!1)}disconnectFromOtherPin(){if(null!==this.connectedPinId){const t=DiagramState.instance.getComponent(this.connectedPinId);t._setConnectedPinId(null),t._setIsConnectedPinSource(!1)}this._setConnectedPinId(null),this._setIsConnectedPinSource(!1)}get voltage(){return this._voltage}_setVoltage(t){this._voltage=t}resetVoltage(){this._setVoltage(0)}_drawChildNodes(t){const e=new Konva.Circle({radius:6,stroke:"red",opacity:DiagramState.instance.showConnectors?1:0,strokeWidth:2});t.add(e)}_applyGlobalStyling(t){}receiveVoltage(t,e,n=null){this._setVoltage(e);if(DiagramState.instance.findComponentsOfType(Wire,e=>e.id!==t&&(e.endPinId==this.id||e.startPinId==this.id)).forEach(t=>t.receiveVoltage(this.id,e)),null!==this.connectedPinId&&n!==this.connectedPinId){DiagramState.instance.getComponent(this.connectedPinId).receiveVoltage(t,e,this.id)}this._emit("voltageChanged",this.voltage)}hasVoltage(){return 0!==this.voltage}}export class Wire extends Component{constructor(t={}){super(t),this.state.color=t.color||DiagramState.instance.WIRE_COLOR_DEFAULT,this._voltage=0,this._pinVoltageIsFrom=null}static get IsDraggable(){return!1}get startPinId(){return this.state.startPinId}get endPinId(){return this.state.endPinId}get startPoint(){return this.state.startPoint}get midPoint(){return this.state.midPoint}get endPoint(){return this.state.endPoint}get color(){return this.state.color}updateStartPoint(t){this.state.startPoint=t}updateEndPoint(t){this.state.endPoint=t}moveTo(t){super.moveTo(t)}get voltage(){return this._voltage}_setVoltage(t){this._voltage=t}resetVoltage(){this._setVoltage(0)}receiveVoltage(t,e){this._setVoltage(e),this._pinVoltageIsFrom=DiagramState.instance.getComponent(t);const n=this.startPinId===t?this.endPinId:this.startPinId;DiagramState.instance.getComponent(n).receiveVoltage(this.id,e,t)}get pinVoltageIsFrom(){return this._pinVoltageIsFrom}hasVoltage(){return 0!==this.voltage}_createRootNode(t){const e=[...this.startPoint,...this.midPoint,...this.endPoint],n=new Konva.Line({points:e,stroke:this.color,strokeWidth:5,lineCap:"butt",lineJoin:"round",draggable:Wire.IsDraggable,tension:.7,id:this.id.toString(),name:this.constructor.name});return n.transformsEnabled("none"),n}_drawChildNodes(t){}_applyGlobalStyling(t){}changeColor(t,e){this.state.color=e,t.stroke(e)}}class InductionCoil{constructor(t,e,n){this._startPin=e,this._endPin=n,this._name=t}induct(){this._startPin.hasVoltage()?this._endPin.receiveVoltage(null,-this._startPin.voltage,this._startPin.id):this._endPin.hasVoltage()?this._startPin.receiveVoltage(null,-this._endPin.voltage,this._endPin.id):this._endPin.receiveVoltage(null,1,this._startPin.id)}stopInducting(){this._endPin.hasVoltage()&&this._endPin.receiveVoltage(this._startPin,0)}}export class Pickup extends Component{constructor(t={}){super(t)}startPickingUp(){throw new Error("Abstract method call")}stopPickingUp(){throw new Error("Abstract method call")}}export class Humbucker extends Pickup{constructor(t={}){super(t),this._northCoil=null,this._southCoil=null}static get ImageURL(){return"/img/pu-humbucker.svg"}pickUp(){this._northCoil=new InductionCoil(`${this.fullName}, North Coil`,this.northCoilFinishPin,this.northCoilStartPin),this._southCoil=new InductionCoil(`${this.fullName}, South Coil`,this.southCoilStartPin,this.southCoilFinishPin),this._northCoil.induct(),this._southCoil.induct()}stopPickingUp(){}get northCoilStartPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get northCoilFinishPin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get southCoilFinishPin(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get southCoilStartPin(){return DiagramState.instance.getComponent(this.pinIds.at(3))}get groundPin(){return DiagramState.instance.getComponent(this.pinIds.at(4))}_createChildComponents(){const t=new Pin({label:`${this.fullName} north coil start`}),e=new Pin({label:`${this.fullName} north coil finish`}),n=new Pin({label:`${this.fullName} south coil finish`}),i=new Pin({label:`${this.fullName} south coil start`}),s=new Pin({label:`${this.fullName} ground`});this.pinIds.push(t.id,e.id,n.id,i.id,s.id)}_drawChildNodes(t){this.northCoilStartPin.moveTo({x:6,y:164}),this.northCoilStartPin.draw(t),this.northCoilFinishPin.moveTo({x:19,y:181}),this.northCoilFinishPin.draw(t),this.southCoilFinishPin.moveTo({x:38,y:182}),this.southCoilFinishPin.draw(t),this.southCoilStartPin.moveTo({x:55,y:172}),this.southCoilStartPin.draw(t),this.groundPin.moveTo({x:62,y:155}),this.groundPin.draw(t),Konva.Image.fromURL(Humbucker.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))})}}export class StratPickup extends Pickup{constructor(t={}){super(t),this._coil=null}static get ImageURL(){return"/img/pu-strat.svg"}get startPin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get endPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}pickUp(){this._coil=new InductionCoil(`${this.fullName} Coil`,this.startPin,this.endPin),this._coil.induct()}stopPickingUp(){this._coil&&this._coil.stopInducting()}_createChildComponents(){const t=new Pin,e=new Pin;this.pinIds.push(t.id,e.id)}_drawChildNodes(t){this.endPin.moveTo({x:140,y:105}),this.endPin.draw(t),this.startPin.moveTo({x:159,y:105}),this.startPin.draw(t),Konva.Image.fromURL(StratPickup.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))})}}export class Jack extends Component{constructor(t={}){super(t)}}export class MonoJack extends Jack{constructor(t={}){super(t),this.tipPin.on("voltageChanged",t=>{this.sleevePin.hasVoltage()||this.sleevePin.receiveVoltage(null,-t,this.tipPin.id)}),this.sleevePin.on("voltageChanged",t=>{this.tipPin.hasVoltage()||this.tipPin.receiveVoltage(null,-t,this.sleevePin.id)})}static get ImageURL(){return"/img/jack-mono.svg"}get tipPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get sleevePin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}_createChildComponents(){const t=new Pin({label:`${this.fullName} tip`}),e=new Pin({label:`${this.fullName} sleeve`});this.pinIds.push(t.id,e.id)}_drawChildNodes(t){this.tipPin.moveTo({x:47,y:10}),this.tipPin.draw(t),this.sleevePin.moveTo({x:48,y:31}),this.sleevePin.draw(t),Konva.Image.fromURL(MonoJack.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))})}}export class Switch extends Component{constructor(t={}){super(t),this.state.actuatorState=this.state.actuatorState||0,this._updatePinConnections()}static get actuatorNodeName(){return"switch-actuator"}static get pinConnectionNodeName(){return"switch-pin-connection"}get actuatorState(){return this.state.actuatorState}_getValidActuatorStates(){return[0,1]}_setActuatorState(t){if(!this._getValidActuatorStates().includes(t))throw new Error(`invalid actuator state ${t}`);this.state.actuatorState=t}flip(t){this._flipActuatorAndSetState(),this._reDrawActuator(t),this._updatePinConnections(),this._reDrawPinConnections(t),DiagramState.instance.notifyNodeChanged(t)}_flipActuatorAndSetState(){throw new Error("abstract method call")}_drawActuator(t){}_reDrawActuator(t){t.findOne("."+Switch.actuatorNodeName).destroy(),this._drawActuator(t)}_updatePinConnections(){}_drawPinConnections(t){}_getAllPins(){return[]}_reDrawPinConnections(t){t.find("."+Switch.pinConnectionNodeName).forEach(t=>{t.destroy()}),this._drawPinConnections(t)}}export class DPDTSwitch extends Switch{constructor(t={}){super(t)}static get _pinsStartAtX(){return 10}static get _pinsStartAtY(){return 9}get pin6(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get pin3(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get pin5(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get pin2(){return DiagramState.instance.getComponent(this.pinIds.at(3))}get pin4(){return DiagramState.instance.getComponent(this.pinIds.at(4))}get pin1(){return DiagramState.instance.getComponent(this.pinIds.at(5))}_createChildComponents(){for(let t=0;t<3;t++)for(let e=0;e<2;e++){const n=new Pin;this.pinIds.push(n.id),n.moveTo({x:DPDTSwitch._pinsStartAtX+22*e,y:DPDTSwitch._pinsStartAtY+15*t})}}_drawChildNodes(t){this.pin1.draw(t),this.pin2.draw(t),this.pin3.draw(t),this.pin4.draw(t),this.pin5.draw(t),this.pin6.draw(t),Konva.Image.fromURL(this.constructor.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex())),this._drawActuator(t),this._drawPinConnections(t)})}_getActuatorImageURLForState(){throw new Error("abstract method call")}_drawActuator(t){Konva.Image.fromURL(this._getActuatorImageURLForState(),e=>{e.position({x:0,y:-35}),e.name(Switch.actuatorNodeName),this._applyGlobalStyling(e),t.add(e)})}_getAllPins(){return[this.pin1,this.pin2,this.pin3,this.pin4,this.pin5,this.pin6]}_drawPinConnections(t){this._getAllPins().forEach(e=>{if(null!==e.connectedPinId&&e.isConnectedPinSource){const n=e.findNode(t).position(),i=DiagramState.instance.getComponent(e.connectedPinId).findNode(t).position(),s=new Konva.Line({name:Switch.pinConnectionNodeName,strokeWidth:5,stroke:"#696969",draggable:!1,points:[n.x,n.y,i.x,i.y]});t.add(s)}})}}export class DPDTOnOn extends DPDTSwitch{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-blue.svg"}_getActuatorImageURLForState(){return 0===this.actuatorState?"/img/bat-small-left.svg":"/img/bat-small-right.svg"}_flipActuatorAndSetState(){this._setActuatorState(0===this.actuatorState?1:0)}_updatePinConnections(){0===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin1),this.pin5.connectToOtherPin(this.pin4)):(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin6))}}export class DPDT3Position extends DPDTSwitch{constructor(t={}){super(t),this._prevActuatorState=-1===this.actuatorState||1===this.actuatorState?0:-1}_getValidActuatorStates(){return[-1,0,1]}_getActuatorImageURLForState(){return-1===this.actuatorState?"/img/bat-small-left.svg":0===this.actuatorState?"/img/bat-small-center.svg":1===this.actuatorState?"/img/bat-small-right.svg":void 0}_flipActuatorAndSetState(){let t;-1===this.actuatorState?t=0:0===this.actuatorState?t=-1===this._prevActuatorState?1:-1:1===this.actuatorState&&(t=0),this._prevActuatorState=this.actuatorState,this._setActuatorState(t)}}export class DPDTOnOffOn extends DPDT3Position{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-purple.svg"}_updatePinConnections(){-1===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin6)):0===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin()):1===this.actuatorState&&(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin1),this.pin5.connectToOtherPin(this.pin4))}}export class DPDTOnOnOn extends DPDT3Position{constructor(t={}){super(t)}static get ImageURL(){return"/img/dpdt-red.svg"}_updatePinConnections(){-1===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin6)):0===this.actuatorState?(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin3),this.pin5.connectToOtherPin(this.pin4)):1===this.actuatorState&&(this.pin2.disconnectFromOtherPin(),this.pin5.disconnectFromOtherPin(),this.pin2.connectToOtherPin(this.pin1),this.pin5.connectToOtherPin(this.pin4))}}export class Potentiometer extends Component{constructor(t={}){super(t),this._setupPinConnections()}static get ImageURL(){return"/img/pot-gr.svg"}static get _pinsStartAtX(){return 25}static get _pinsStartAtY(){return 110}get startPin(){return DiagramState.instance.getComponent(this.pinIds.at(0))}get endPin(){return DiagramState.instance.getComponent(this.pinIds.at(1))}get wiperPin(){return DiagramState.instance.getComponent(this.pinIds.at(2))}get groundPin(){return DiagramState.instance.getComponent(this.pinIds.at(3))}_createChildComponents(){for(let t=0;t<3;t++){const e=new Pin;this.pinIds.push(e.id),e.moveTo({x:Potentiometer._pinsStartAtX+24*t,y:Potentiometer._pinsStartAtY})}const t=new Pin;this.pinIds.push(t.id),t.moveTo({x:77,y:64})}_setupPinConnections(){this.startPin.connectToOtherPin(this.wiperPin),this.wiperPin.connectToOtherPin(this.endPin)}_drawChildNodes(t){this.startPin.draw(t),this.endPin.draw(t),this.wiperPin.draw(t),this.groundPin.draw(t),Konva.Image.fromURL(Potentiometer.ImageURL,e=>{this._applyGlobalStyling(e),t.add(e),this._getPinNodes(t).forEach(t=>t.zIndex(e.zIndex()))})}}export const componentClassMap={Potentiometer:Potentiometer,DPDTOnOn:DPDTOnOn,DPDTOnOffOn:DPDTOnOffOn,DPDTOnOnOn:DPDTOnOnOn,Humbucker:Humbucker,StratPickup:StratPickup,MonoJack:MonoJack,Wire:Wire,Pin:Pin};

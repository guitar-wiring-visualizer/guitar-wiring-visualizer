/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState}from"./diagram.js";export class Visualizer{constructor(t){if(Visualizer.instance)return Visualizer.instance;this._diagramLayer=t,this._visLayer=new Konva.Layer({visible:!1});this._diagramLayer.getStage().add(this._visLayer),this._isActive=!1,this._activeWireNodes=[],this._createAllAnimations(),DiagramState.instance.on("wireChanged",t=>{const i=this.isActive;this.stop(),i&&this.start()}),Visualizer.instance=this}_createAllAnimations(){this._animations=[this._createActiveWireAnimation()].concat(this._createSignalWireAnimations()).filter(Boolean)}get isActive(){return this._isActive}start(){this._refreshActiveWireNodesList(),this._createAllAnimations(),this._isActive=!0,this._visLayer.visible(!0),this._animations.forEach(t=>t.start())}stop(){this._animations.forEach(t=>t.stop()),this._visLayer.visible(!1),this._isActive=!1}_refreshActiveWireNodesList(){this._visLayer.destroyChildren();const t=DiagramState.instance.findComponents(t=>"Wire"===t.constructor.name&&t.hasVoltage()).filter(Boolean).map(t=>this._diagramLayer.findOne("#"+t.id.toString())).filter(Boolean);this._activeWireNodes=t.map(t=>{const i=t.clone({shadowColor:t.stroke()});return this._visLayer.add(i),i}).filter(Boolean)}_createActiveWireAnimation(){let t=0,i=!0;return new Konva.Animation(e=>{(t>11||t<0)&&(t=0,i=!0),t>10&&(i=!1);const a=e.timeDiff/1e3*15;i?t+=a:t-=a,this._activeWireNodes.forEach(i=>{i.shadowBlur(t),i.shadowOpacity(10/t)})},this._visLayer)}_createSignalWireAnimations(){const t=t=>{const i=t.points(),e=t.getTensionPoints(),a=6===i.length&&6===e.length?[i.at(0),i.at(1),e.at(0),e.at(1),i.at(2),i.at(3),e.at(4),e.at(5),i.at(4),i.at(5)]:i,s={x:a.at(0),y:a.at(1)},n=new Konva.Circle({x:s.x,y:s.y,radius:4,fill:"cyan",shadowColor:"#35FF1F",shadowBlur:10,shadowOffset:{x:-5,y:0},shadowOpacity:1});this._visLayer.add(n);const r=function(t){let i="M "+t[0]+","+t[1];for(let e=2;e<t.length;e+=2)i+=" L "+t[e]+","+t[e+1];return i}(a),o=new Konva.Path({data:r,stroke:"cyan",strokeWidth:1,fill:"transparent"}),h=o.getLength(),c=h/17;let l,d=0;return new Konva.Animation(t=>{d*c>h&&(d=0),d+=1,l=o.getPointAtLength(d*c),n.position({x:l.x,y:l.y})},this._visLayer)};return this._activeWireNodes.map(i=>t(i))}}

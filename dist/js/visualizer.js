import {DiagramState as A} from'./diagram.js';export class Visualizer{constructor(_){if(Visualizer.instance)return Visualizer.instance;this._diagramLayer=_;this._visLayer=new Konva.Layer({visible:!1});let b=this._diagramLayer.getStage();b.add(this._visLayer);this._isActive=!1;this._activeWireNodes=[];this._createAllAnimations();A.instance.on('wireChanged',()=>{let B=this.isActive;B&&this.stop();this._refreshActiveWireNodesList();this._createAllAnimations();B&&this.start()});Visualizer.instance=this}_createAllAnimations(){this._animations=[this._createActiveWireAnimation()].concat(this._createSignalWireAnimations())}get isActive(){return this._isActive}start(){this._isActive=!0;this._visLayer.visible(!0);this._animations.filter(a=>a!=null).forEach(a=>a.start())}stop(){this._animations.filter(a=>a!=null).forEach(a=>a.stop());this._visLayer.visible(!1);this._isActive=!1}_refreshActiveWireNodesList(){this._visLayer.destroyChildren();let c=A.instance.findComponents(_a=>_a.constructor.name==='Wire'),C=c.filter(a=>a!=null).map(d=>this._diagramLayer.findOne('#'+`${d.id}`));this._activeWireNodes=C.filter(a=>a!=null).map(D=>{let _b=D.clone({shadowColor:D.stroke()});this._visLayer.add(_b);return _b})}_createActiveWireAnimation(){let _A=15,_B=1000,_c=10,_d=0,e=!0;return new Konva.Animation(E=>{(_d>_c+1||_d<0)&&(_d=0,e=!0);_d>_c&&(e=!1);let aA=(E.timeDiff/_B)*_A;e?_d=_d+aA:_d=_d-aA;this._activeWireNodes.filter(a=>a!=null).forEach(aB=>{aB.shadowBlur(_d);aB.shadowOpacity(10/_d)})}, this._visLayer)}_createSignalWireAnimations(){let aC=17,aD=aE=>{let aF=aE.points(),_C=aE.getTensionPoints(),_D=aF.length===6&&_C.length===6?[aF.at(0),aF.at(1),_C.at(0),_C.at(1),aF.at(2),aF.at(3),_C.at(4),_C.at(5),aF.at(4),aF.at(5)]:aF,_e={x:_D.at(0),y:_D.at(1)},I=aC,j=h.getLength(),k=j/I;let f=new Konva.Circle({x:_e.x,y:_e.y,radius:4,fill:'cyan',shadowColor:'#35FF1F',shadowBlur:10,shadowOffset:{x:-5,y:0},shadowOpacity:1});this._visLayer.add(f);let g=n(_D);let h=new Konva.Path({data:g,stroke:'cyan',strokeWidth:1,fill:'transparent'});let l=0,m;return new Konva.Animation(()=>{l*k>j&&(l=0);l=l+1;m=h.getPointAtLength(l*k);f.position({x:m.x,y:m.y})}, this._visLayer);function n(aG){let aH='M '+aG[0]+','+aG[1];for(let i=2;i<aG.length;i+=2)aH+=' L '+aG[i]+','+aG[i+1];return aH}};return this._activeWireNodes.filter(a=>a!=null).map(aI=>aD(aI))}}

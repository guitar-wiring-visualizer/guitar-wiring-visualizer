/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState}from"./diagram.js";import{Wire}from"./components.js";export class Visualizer{constructor(i){if(Visualizer.instance)return Visualizer.instance;this._diagramLayer=i,this._visLayer=new Konva.Layer({visible:!1});this._diagramLayer.getStage().add(this._visLayer),this._isActive=!1,this._activeWireNodes=[],this._signalWireNodes=[],this._createAllAnimations(),DiagramState.instance.on("wireChanged",i=>{const t=this.isActive;this.stop(),t&&this.start()}),Visualizer.instance=this}_createAllAnimations(){this._animations=[this._createActiveWireAnimation()].concat(this._createSignalWireAnimations()).filter(Boolean)}get isActive(){return this._isActive}start(){this._refreshWireNodesLists(),this._createAllAnimations(),this._isActive=!0,this._visLayer.visible(!0),this._animations.forEach(i=>i.start())}stop(){this._animations.forEach(i=>i.stop()),this._visLayer.visible(!1),this._isActive=!1}_refreshWireNodesLists(){this._visLayer.destroyChildren(),this._activeWireNodes=[],this._signalWireNodes=[];DiagramState.instance.findComponentsOfType(Wire,i=>i.hasVoltage()).filter(Boolean).forEach(i=>{const t=i.findNode(this._diagramLayer),e=t.clone({shadowColor:t.stroke()});this._visLayer.add(e),this._activeWireNodes.push(e),i.voltage>0&&this._signalWireNodes.push(e)})}_createActiveWireAnimation(){let i=0,t=!0;return new Konva.Animation(e=>{(i>11||i<0)&&(i=0,t=!0),i>10&&(t=!1);const s=e.timeDiff/1e3*15;t?i+=s:i-=s,this._activeWireNodes.forEach(t=>{t.shadowBlur(i),t.shadowOpacity(10/i)})},this._visLayer)}_createSignalWireAnimations(){const i=i=>{const t=i.points(),e=i.getTensionPoints(),s=6===t.length&&6===e.length?[t.at(0),t.at(1),e.at(0),e.at(1),t.at(2),t.at(3),e.at(4),e.at(5),t.at(4),t.at(5)]:t,a={x:s.at(0),y:s.at(1)},r=new Konva.Circle({x:a.x,y:a.y,radius:4,fill:"cyan",shadowColor:"#35FF1F",shadowBlur:10,shadowOffset:{x:-5,y:0},shadowOpacity:1});this._visLayer.add(r);const n=function(i){let t="M "+i[0]+","+i[1];for(let e=2;e<i.length;e+=2)t+=" L "+i[e]+","+i[e+1];return t}(s),o=new Konva.Path({data:n,stroke:"cyan",strokeWidth:1,fill:"transparent"}),h=o.getLength(),c=h/17;let l,d=0;return new Konva.Animation(i=>{d*c>h&&(d=0),d+=1,l=o.getPointAtLength(d*c),r.position({x:l.x,y:l.y})},this._visLayer)};return this._signalWireNodes.map(t=>i(t))}}

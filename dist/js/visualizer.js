/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState,WIRE_COLOR_BLACK,WIRE_COLOR_BLUE,WIRE_COLOR_GREEN,WIRE_COLOR_RED,WIRE_COLOR_YELLOW}from"./diagram.js";import{EventDispatcher,Events}from"./events.js";import{Wire}from"./components.js";const RANGE_FOR_CLOSE_POINT_COMPARISON=2;export const VISUALIZER_WIRE_LINE_NAME="vis-wire";export const VISUALIZER_SIGNAL_PATH_NAME="vis-path";export class Visualizer{constructor(t){if(Visualizer.instance)return Visualizer.instance;this._diagramLayer=t,this._visLayer=new Konva.Layer({visible:!1});this._diagramLayer.getStage().add(this._visLayer),this._isActive=!1,this._activeWireNodes=[],this._signalWireNodes=[],this._createAllAnimations(),this._subscribeToEvents(),Visualizer.instance=this}_subscribeToEvents(){EventDispatcher.instance.on(Events.WireColorChanged,t=>{const i=this.isActive;this.stop(),i&&this.start()}),EventDispatcher.instance.on(Events.SwitchFlipped,t=>{this._restartAfterDiagramChange()}),EventDispatcher.instance.on(Events.PotRotated,t=>{this._restartAfterDiagramChange()}),EventDispatcher.instance.on(Events.ComponentDrawn,t=>{["Pin"].includes(t.kind)||this._restartAfterDiagramChange()}),EventDispatcher.instance.on(Events.ComponentRedrawn,t=>{}),EventDispatcher.instance.on(Events.ComponentMoved,t=>{this._restartAfterDiagramChange()}),EventDispatcher.instance.on(Events.ComponentRemoved,t=>{this._restartAfterDiagramChange()})}_restartAfterDiagramChange(){const t=this.isActive;this.stop(),DiagramState.instance.stop(),t&&(DiagramState.instance.start(),this.start())}_createAllAnimations(){this._animations=[this._createActiveWireAnimation()].concat(this._createSignalWireAnimations()).filter(Boolean)}get isActive(){return this._isActive}start(){this._refreshWireNodesLists(),this._createAllAnimations(),this._isActive=!0,this._visLayer.visible(!0),this._animations.forEach(t=>t.start())}stop(){this._animations.forEach(t=>t.stop()),this._visLayer.visible(!1),this._isActive=!1}_refreshWireNodesLists(){this._visLayer.destroyChildren(),this._activeWireNodes=[],this._signalWireNodes=[],DiagramState.instance.findComponentsOfType(Wire,t=>t.hasVoltage()).filter(Boolean).forEach(t=>{const i=t.findNode(this._diagramLayer);let e=i.points();if(t.voltage>0){const i=t.pinVoltageIsFrom.findNode(this._diagramLayer).getAbsolutePosition(),n=e.at(-2);s=i.x,a=n,Math.abs(s-a)<=2&&(e=function(t){const i=[];for(let e=t.length-1;e>=1;e-=2)i.push(t.at(e-1)),i.push(t.at(e));return i}(e))}var s,a;const n=i.clone({name:"vis-wire",id:"vis-wire."+t.id,points:e,shadowColor:i.stroke()});this._visLayer.add(n),this._activeWireNodes.push(n),t.voltage>0&&this._signalWireNodes.push(n)})}_createActiveWireAnimation(){let t=0,i=!0;return new Konva.Animation(e=>{(t>11||t<0)&&(t=0,i=!0),t>10&&(i=!1);const s=e.timeDiff/1e3*15;i?t+=s:t-=s,this._activeWireNodes.forEach(i=>{i.shadowBlur(t),i.shadowOpacity(10/t)})},this._visLayer)}_createSignalWireAnimations(){const t=t=>{const i=t.points(),e=t.getTensionPoints(),s=6===i.length&&6===e.length?[i.at(0),i.at(1),e.at(0),e.at(1),i.at(2),i.at(3),e.at(4),e.at(5),i.at(4),i.at(5)]:i,a={x:s.at(0),y:s.at(1)},{fill:n,shadow:r}=function(){let i,e;t.stroke(),e="#35FF1F",i="cyan";return{fill:i,shadow:e}}(),o=new Konva.Circle({x:a.x,y:a.y,radius:4,fill:n,shadowColor:r,shadowBlur:10,shadowOffset:{x:-5,y:0},perfectDrawEnable:!1,shadowOpacity:1});this._visLayer.add(o);const h=function(t){let i="M "+t[0]+","+t[1];for(let e=2;e<t.length;e+=2)i+=" L "+t[e]+","+t[e+1];return i}(s),c=new Konva.Path({name:"vis-path",id:"vis-path."+t.id().replace("vis-wire.",""),data:h,stroke:"cyan",strokeWidth:1,fill:"transparent"}),_=c.getLength(),v=_/17;let l,d=0;return new Konva.Animation(t=>{d*v>_&&(d=0),d+=1,l=c.getPointAtLength(d*v),o.position({x:l.x,y:l.y})},this._visLayer)};return this._signalWireNodes.map(i=>t(i))}}

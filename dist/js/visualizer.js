/**
 * @license AGPLv3
 * SPDX-License-Identifier: AGPLv3
 * SPDX-FileCopyrightText: Copyright (c) 2026 The Guitar Wiring Visualizer Authors
 */
import{DiagramState}from"./diagram.js";import{Wire}from"./components.js";const RANGE_FOR_CLOSE_POINT_COMPARISON=2;export class Visualizer{constructor(t){if(Visualizer.instance)return Visualizer.instance;this._diagramLayer=t,this._visLayer=new Konva.Layer({visible:!1});this._diagramLayer.getStage().add(this._visLayer),this._isActive=!1,this._activeWireNodes=[],this._signalWireNodes=[],this._createAllAnimations(),DiagramState.instance.on("wireChanged",t=>{const i=this.isActive;this.stop(),i&&this.start()}),Visualizer.instance=this}_createAllAnimations(){this._animations=[this._createActiveWireAnimation()].concat(this._createSignalWireAnimations()).filter(Boolean)}get isActive(){return this._isActive}start(){this._refreshWireNodesLists(),this._createAllAnimations(),this._isActive=!0,this._visLayer.visible(!0),this._animations.forEach(t=>t.start())}stop(){this._animations.forEach(t=>t.stop()),this._visLayer.visible(!1),this._isActive=!1}_refreshWireNodesLists(){this._visLayer.destroyChildren(),this._activeWireNodes=[],this._signalWireNodes=[],DiagramState.instance.findComponentsOfType(Wire,t=>t.hasVoltage()).filter(Boolean).forEach(t=>{const i=t.findNode(this._diagramLayer);let e=i.points();if(t.voltage>0){const i=t.pinVoltageIsFrom.findNode(this._diagramLayer).getAbsolutePosition(),n=e.at(-2);s=i.x,a=n,Math.abs(s-a)<=2&&(e=function(t){const i=[];for(let e=t.length-1;e>=1;e-=2)i.push(t.at(e-1)),i.push(t.at(e));return i}(e))}var s,a;const n=i.clone({points:e,shadowColor:i.stroke()});this._visLayer.add(n),this._activeWireNodes.push(n),t.voltage>0&&this._signalWireNodes.push(n)})}_createActiveWireAnimation(){let t=0,i=!0;return new Konva.Animation(e=>{(t>11||t<0)&&(t=0,i=!0),t>10&&(i=!1);const s=e.timeDiff/1e3*15;i?t+=s:t-=s,this._activeWireNodes.forEach(i=>{i.shadowBlur(t),i.shadowOpacity(10/t)})},this._visLayer)}_createSignalWireAnimations(){const t=t=>{const i=t.points(),e=t.getTensionPoints(),s=6===i.length&&6===e.length?[i.at(0),i.at(1),e.at(0),e.at(1),i.at(2),i.at(3),e.at(4),e.at(5),i.at(4),i.at(5)]:i,a={x:s.at(0),y:s.at(1)},n=new Konva.Circle({x:a.x,y:a.y,radius:4,fill:"cyan",shadowColor:"#35FF1F",shadowBlur:10,shadowOffset:{x:-5,y:0},shadowOpacity:1});this._visLayer.add(n);const r=function(t){let i="M "+t[0]+","+t[1];for(let e=2;e<t.length;e+=2)i+=" L "+t[e]+","+t[e+1];return i}(s),o=new Konva.Path({data:r,stroke:"cyan",strokeWidth:1,fill:"transparent"}),h=o.getLength(),c=h/17;let l,_=0;return new Konva.Animation(t=>{_*c>h&&(_=0),_+=1,l=o.getPointAtLength(_*c),n.position({x:l.x,y:l.y})},this._visLayer)};return this._signalWireNodes.map(i=>t(i))}}
